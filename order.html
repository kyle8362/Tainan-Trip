<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠé é»é¤ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; padding: 20px; max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .sub-title { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 20px; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* èœå–®åˆ—è¡¨ */
        .menu-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #ddd; padding: 15px 0; }
        .menu-item:last-child { border-bottom: none; }
        .item-info { flex-grow: 1; padding-right: 10px; }
        .item-name { font-weight: bold; font-size: 1.1rem; display: block; color: #333; }
        .item-price { color: #e67e22; font-weight: bold; }
        
        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        .qty-input { width: 60px; text-align: center; font-weight: bold; }
        
        .btn-submit { 
            width: 100%; padding: 15px; background: #27ae60; color: white; 
            border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; margin-top: 15px; transition: all 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; box-shadow: none; }
        
        .btn-back { display: block; text-align: center; margin-top: 30px; color: #7f8c8d; text-decoration: none; padding: 10px; border-radius: 20px; border: 1px solid #ddd; background: white;}

        /* ç‹€æ…‹åˆ— */
        #status-msg { text-align: center; padding: 10px; background: #ffeaa7; border-radius: 8px; margin-bottom: 15px; font-weight: bold; color: #d35400; display: none; }

        /* ç®¡ç†å“¡éš±è—å…¥å£ (å³ä¸Šè§’) */
        .admin-trigger { position: fixed; top: 10px; right: 10px; opacity: 0.2; font-size: 1.5rem; cursor: pointer; z-index: 999; }
        
        /* ç®¡ç†å¾Œå°æ¨£å¼ */
        #admin-panel { display: none; border: 2px solid #e74c3c; background: #fff5f5; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;}
        .btn-lock { padding: 8px 20px; border-radius: 5px; border: none; cursor: pointer; color: white; font-weight: bold; }
        .is-unlocked { background: #27ae60; } 
        .is-locked { background: #c0392b; } 
        
        .stat-item { display: flex; justify-content: space-between; margin: 8px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .total-row { font-weight: bold; font-size: 1.3rem; color: #c0392b; margin-top: 15px; border-top: 2px solid #333; padding-top: 10px; text-align: right;}
    </style>
</head>
<body>

    <h2>ğŸœ é å…ˆé»é¤ç³»çµ±</h2>
    <div class="sub-title">å¤§å®¶å…ˆé»å¥½ï¼Œå»åˆ°ç¾å ´ç›´æ¥åƒï¼</div>
    
    <div id="status-msg">âš ï¸ ç›®å‰å·²åœæ­¢æ”¶å–®</div>

    <div id="order-section" class="card">
        <div style="margin-bottom: 20px;">
            <label style="font-weight: bold; display: block; margin-bottom: 5px;">æ‚¨çš„å§“åï¼š</label>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥åå­— (ä¾‹å¦‚: å¸¥å“¥æ™º)" style="width: 90%;">
        </div>
        <hr style="border: 0; border-top: 2px solid #eee;">
        
        <div id="menu-list">
            </div>

        <div style="text-align: right; margin-top: 20px; font-size: 1.2rem; font-weight: bold; color: #2c3e50;">
            ç¸½é‡‘é¡ï¼š<span style="color: #e74c3c;">$</span><span id="current-total" style="color: #e74c3c; font-size: 1.5rem;">0</span>
        </div>
        
        <button id="btn-submit" class="btn-submit">é€å‡ºè¨‚å–®</button>
    </div>

    <a href="index.html" class="btn-back">â¬… å›åˆ°è¡Œç¨‹è¡¨</a>

    <div class="admin-trigger" onclick="openAdmin()">âš™ï¸</div>

    <div id="admin-panel" class="card">
        <div class="admin-header">
            <h3 style="margin:0;">ğŸ“Š é»é¤çµ±è¨ˆå¾Œå°</h3>
            <button id="btn-toggle-lock" class="btn-lock is-unlocked">é–å®šç‹€æ…‹è®€å–ä¸­...</button>
        </div>
        <div id="admin-stats" style="line-height: 1.6;">è³‡æ–™è¼‰å…¥ä¸­...</div>
    </div>

    <script type="module">
        // å¼•å…¥ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜…â˜…â˜… æ‚¨çš„å°ˆå±¬è¨­å®šæª” â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyC_S8VS1Tgtjdh2eyavGR3jN2BmWF_Etg4",
            authDomain: "tainan-trip-order.firebaseapp.com",
            projectId: "tainan-trip-order",
            storageBucket: "tainan-trip-order.firebasestorage.app",
            messagingSenderId: "171271367128",
            appId: "1:171271367128:web:91d2cb419a35902dec2aad",
            measurementId: "G-Y8P3XCTS1Q"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 1. èœå–®è¨­å®š (æ‚¨å¯ä»¥éš¨æ™‚åœ¨é€™è£¡ä¿®æ”¹èœå–®) ---
        const menuData = [
            { id: "item_1", name: "æ‹›ç‰Œç‰›è‚‰éºµ", price: 150 },
            { id: "item_2", name: "é®®è¦é¤›é£©éºµ", price: 100 },
            { id: "item_3", name: "å¤æ—©å‘³æ»·è‚‰é£¯", price: 45 },
            { id: "item_4", name: "ç‡™é’èœ", price: 40 },
            { id: "item_5", name: "æ»·å‘³æ‹¼ç›¤", price: 60 },
            { id: "item_6", name: "å†°é®ç´…èŒ¶", price: 25 }
        ];

        // --- 2. å‰ç«¯é‚è¼¯ ---
        const menuListEl = document.getElementById('menu-list');
        const currentTotalEl = document.getElementById('current-total');
        const btnSubmit = document.getElementById('btn-submit');
        const statusMsg = document.getElementById('status-msg');
        let orderItems = {}; 

        // åˆå§‹åŒ–èœå–®ç•«é¢
        function renderMenu() {
            menuListEl.innerHTML = '';
            menuData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">$${item.price}</span>
                    </div>
                    <input type="number" min="0" class="qty-input" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}" placeholder="0">
                `;
                menuListEl.appendChild(div);
            });

            // ç¶å®šè¼¸å…¥äº‹ä»¶è¨ˆç®—é‡‘é¡
            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('input', calculateTotal);
                input.addEventListener('focus', function() { if(this.value=='0') this.value=''; }); // é»æ“Šæ¸…ç©º0
                input.addEventListener('blur', function() { if(this.value=='') this.value=''; });
            });
        }

        function calculateTotal() {
            let total = 0;
            orderItems = {}; 
            document.querySelectorAll('.qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    const price = parseInt(input.dataset.price);
                    const id = input.dataset.id;
                    const name = input.dataset.name;
                    total += qty * price;
                    orderItems[id] = { name: name, qty: qty, price: price };
                }
            });
            currentTotalEl.innerText = total;
        }

        renderMenu();

        // --- 3. Firebase ç›£è½é–å–®ç‹€æ…‹ ---
        const configRef = ref(db, 'config/isLocked');
        onValue(configRef, (snapshot) => {
            const isLocked = snapshot.val();
            const toggleBtn = document.getElementById('btn-toggle-lock');
            
            if (isLocked) {
                // é–å®šç‹€æ…‹
                statusMsg.style.display = 'block';
                btnSubmit.disabled = true;
                btnSubmit.innerText = "ğŸš« å·²æˆªæ­¢æ”¶å–®";
                btnSubmit.style.background = "#95a5a6";
                // å¾Œå°æŒ‰éˆ•
                if(toggleBtn) {
                    toggleBtn.innerText = "ç›®å‰ï¼šå·²é–å®š (é»æ­¤è§£é–)";
                    toggleBtn.className = "btn-lock is-locked";
                }
            } else {
                // é–‹æ”¾ç‹€æ…‹
                statusMsg.style.display = 'none';
                btnSubmit.disabled = false;
                btnSubmit.innerText = "é€å‡ºè¨‚å–®";
                btnSubmit.style.background = "#27ae60";
                // å¾Œå°æŒ‰éˆ•
                if(toggleBtn) {
                    toggleBtn.innerText = "ç›®å‰ï¼šé–‹æ”¾ä¸­ (é»æ­¤é–å®š)";
                    toggleBtn.className = "btn-lock is-unlocked";
                }
            }
        });

        // --- 4. é€å‡ºè¨‚å–® ---
        btnSubmit.addEventListener('click', () => {
            const name = document.getElementById('username').value.trim();
            const total = parseInt(currentTotalEl.innerText);

            if (!name) { alert("è«‹è¼¸å…¥æ‚¨çš„å§“åï¼"); return; }
            if (total === 0) { alert("æ‚¨é‚„æ²’æœ‰é»ä»»ä½•æ±è¥¿å–”ï¼"); return; }

            // é›™é‡ç¢ºèªé–å–®ç‹€æ…‹
            get(configRef).then((snapshot) => {
                if (snapshot.val() === true) {
                    alert("æŠ±æ­‰ï¼Œå‰›å‰›å·²ç¶“æˆªæ­¢æ”¶å–®äº†ï¼");
                    return;
                }

                // æº–å‚™è³‡æ–™
                const newOrder = {
                    name: name,
                    items: orderItems,
                    totalPrice: total,
                    timestamp: new Date().toLocaleString()
                };

                // æ¨é€åˆ° Firebase
                push(ref(db, 'orders'), newOrder)
                    .then(() => {
                        alert(`è¨‚å–®é€å‡ºæˆåŠŸï¼\n${name} ç¸½å…± $${total}`);
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('username').value = '';
                        document.querySelectorAll('.qty-input').forEach(input => input.value = '');
                        calculateTotal();
                    })
                    .catch((error) => {
                        alert("é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚\n" + error.message);
                    });
            });
        });

        // --- 5. ç®¡ç†å“¡å¾Œå°é‚è¼¯ ---
        window.openAdmin = function() {
            const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pwd === "8888") { // â˜… é è¨­å¯†ç¢¼ 8888ï¼Œå¯è‡ªè¡Œä¿®æ”¹
                document.getElementById('admin-panel').style.display = 'block';
                // è‡ªå‹•æ²å‹•åˆ°å¾Œå°
                document.getElementById('admin-panel').scrollIntoView({behavior: "smooth"});
                loadAdminData(); 
            } else {
                if(pwd !== null) alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        };

        // åˆ‡æ›é–å–®
        document.getElementById('btn-toggle-lock').addEventListener('click', () => {
            get(configRef).then((snapshot) => {
                const currentStatus = snapshot.val() || false;
                set(configRef, !currentStatus);
            });
        });

        // è¨ˆç®—çµ±è¨ˆ
        function loadAdminData() {
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val();
                if (!orders) {
                    document.getElementById('admin-stats').innerText = "ç›®å‰æ²’æœ‰è¨‚å–®ã€‚";
                    return;
                }

                let itemCounts = {}; 
                let grandTotal = 0;
                let orderCount = 0;
                let orderDetails = "";

                // éæ­·è¨‚å–®
                Object.values(orders).forEach(order => {
                    orderCount++;
                    grandTotal += order.totalPrice;
                    
                    // çµ±è¨ˆå“é …
                    if (order.items) {
                        Object.values(order.items).forEach((item) => {
                            if (!itemCounts[item.name]) itemCounts[item.name] = 0;
                            itemCounts[item.name] += item.qty;
                        });
                    }
                    // è¨‚å–®æ˜ç´° (é™¤éŒ¯ç”¨ï¼Œå¯ä¸é¡¯ç¤º)
                    // orderDetails += `${order.name}: $${order.totalPrice}<br>`;
                });

                // ç”¢ç”Ÿ HTML
                let html = `<div style="margin-bottom:10px; font-weight:bold;">ç¸½å–®æ•¸ï¼š${orderCount} ç­†</div>`;
                
                // é¡¯ç¤ºå“é …çµ±è¨ˆ
                for (const [name, qty] of Object.entries(itemCounts)) {
                    html += `
                        <div class="stat-item">
                            <span>${name}</span>
                            <span style="font-weight:bold; color:#2980b9;">x ${qty}</span>
                        </div>
                    `;
                }

                html += `<div class="total-row">ğŸ’° ç¸½é‡‘é¡ï¼š$${grandTotal}</div>`;
                document.getElementById('admin-stats').innerHTML = html;
            });
        }
    </script>
</body>
</html>

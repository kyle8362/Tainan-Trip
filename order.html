<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹é»é¤ç³»çµ± (Firebaseç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f8f9fa; }
        .container { max-width: 800px; margin-top: 30px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .time-display { font-weight: bold; color: #d9534f; }
        
        /* å¾Œå°å°ˆç”¨æ¨£å¼ */
        #backend-dashboard { display: none; background-color: #e9ecef; padding: 30px; min-height: 100vh; }
        .backend-card { border-left: 5px solid #0d6efd; margin-bottom: 15px; background: white; padding: 15px; }
        .stats-result-box { background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #ccc; margin-top: 15px; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="frontend-app" class="container">
    <h1 class="text-center mb-4">ğŸšŒ æ—…éŠè¡Œç¨‹é»é¤ç³»çµ±</h1>

    <div class="alert alert-info text-center">
        <h5>â° é»é¤å€’æ•¸è¨ˆæ™‚</h5>
        <div class="row">
            <div class="col-md-6">
                <p>DAY 2 (2/20 10:30): <br><span id="timer-day2" class="time-display">è¨ˆç®—ä¸­...</span></p>
            </div>
            <div class="col-md-6">
                <p>DAY 3 (2/21 10:30): <br><span id="timer-day3" class="time-display">è¨ˆç®—ä¸­...</span></p>
            </div>
        </div>
    </div>

    <div class="card p-4">
        <h4>æ‚¨çš„é»é¤è³‡è¨Š</h4>
        <div class="mb-3">
            <label class="form-label">æ‚¨çš„å§“å/å®¶åº­ä»£è™Ÿï¼š</label>
            <input type="text" id="user-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ (å¿…å¡«)">
        </div>

        <hr>

        <div class="mb-3">
            <label class="form-label">DAY 2 é¤é» (2/20)ï¼š</label>
            <input type="text" id="input-day2" class="form-control day2-input" placeholder="è«‹è¼¸å…¥é¤é»">
            <small class="text-muted" id="status-day2">é–‹æ”¾é»é¤ä¸­</small>
        </div>

        <div class="mb-3">
            <label class="form-label">DAY 3 é¤é» (2/21)ï¼š</label>
            <input type="text" id="input-day3" class="form-control day3-input" placeholder="è«‹è¼¸å…¥é¤é»">
            <small class="text-muted" id="status-day3">é–‹æ”¾é»é¤ä¸­</small>
        </div>

        <button onclick="submitOrder()" class="btn btn-primary w-100 btn-lg">é€å‡º / æ›´æ–°è¨‚å–®</button>
        <small class="text-muted text-center d-block mt-2">è‹¥éœ€ä¿®æ”¹ï¼Œè«‹è¼¸å…¥ç›¸åŒå§“åå¾Œæ›´æ”¹å…§å®¹ä¸¦å†æ¬¡é€å‡ºå³å¯ã€‚</small>
    </div>

    <div class="text-center mt-5 mb-5">
        <button onclick="checkAdminPassword()" class="btn btn-outline-secondary btn-sm">ğŸ”’ ç®¡ç†å“¡å¾Œå°</button>
    </div>
</div>

<div id="backend-dashboard">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>âš™ï¸ å¾Œå°ç®¡ç†çµ±æ•´ç³»çµ±</h2>
            <button onclick="logoutBackend()" class="btn btn-danger">ç™»å‡ºä¸¦è¿”å›å‰å°</button>
        </div>

        <div class="card p-3 mb-4">
            <h4>ğŸ”’ å¼·åˆ¶é–å®šæ§åˆ¶</h4>
            <p class="text-muted small">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¯å¼·åˆ¶é–å®šæˆ–è§£é–ã€‚æ­¤è¨­å®šæœƒå³æ™‚åŒæ­¥çµ¦æ‰€æœ‰ä½¿ç”¨è€…ã€‚</p>
            <div class="d-flex gap-3">
                <button id="admin-btn-day2" onclick="toggleAdminLock('day2')" class="btn btn-secondary">è®€å–ä¸­...</button>
                <button id="admin-btn-day3" onclick="toggleAdminLock('day3')" class="btn btn-secondary">è®€å–ä¸­...</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>ğŸ“‹ å„å®¶é»é¤æ˜ç´°</h4>
                        <span id="order-count" class="badge bg-secondary">0 ç­†è¨‚å–®</span>
                    </div>
                    <div id="all-orders-list" style="max-height: 600px; overflow-y: auto;">
                        <div class="text-center text-muted mt-3">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card p-3">
                    <h4>ğŸ“Š é¤é»æ•¸é‡çµ±è¨ˆ</h4>
                    <div class="d-grid gap-2 mb-3">
                        <button onclick="calculateTotals('day2')" class="btn btn-warning">çµ±æ•´ DAY 2 (2/20) æ•¸é‡</button>
                        <button onclick="calculateTotals('day3')" class="btn btn-info">çµ±æ•´ DAY 3 (2/21) æ•¸é‡</button>
                    </div>
                    
                    <div id="stats-result" class="stats-result-box">
                        <p class="text-center text-muted">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æŸ¥çœ‹çµ±è¨ˆçµæœ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC_S8VS1Tgtjdh2eyavGR3jN2BmWF_Etg4",
        authDomain: "tainan-trip-order.firebaseapp.com",
        databaseURL: "https://tainan-trip-order-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tainan-trip-order",
        storageBucket: "tainan-trip-order.firebasestorage.app",
        messagingSenderId: "171271367128",
        appId: "1:171271367128:web:91d2cb419a35902dec2aad",
        measurementId: "G-Y8P3XCTS1Q"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================== è¨­å®šè®Šæ•¸ ==================
    // è¨­å®šæˆªæ­¢æ™‚é–“ (2026å¹´)
    const DEADLINES = {
        day2: new Date('2026-02-20T10:30:00').getTime(),
        day3: new Date('2026-02-21T10:30:00').getTime()
    };

    // å…¨å±€è®Šæ•¸å„²å­˜å¾Œå°é–å®šç‹€æ…‹
    let adminLockState = {
        day2: false,
        day3: false
    };

    // æœ¬åœ°è¨‚å–®å¿«å– (ç”¨æ–¼çµ±è¨ˆ)
    let cachedOrders = {};

    // ================== æ ¸å¿ƒé‚è¼¯ï¼šç›£è½é–å®šç‹€æ…‹ ==================
    // â˜…â˜…â˜… ä¿®æ­£é‡é»ï¼šç›£è½è³‡æ–™åº«è®Šå‹•ï¼Œç¢ºä¿ã€ŒæŒ‰ä¸‹å»æœ‰åæ‡‰ã€ä¸”åŒæ­¥ â˜…â˜…â˜…
    db.ref('adminSettings').on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            adminLockState.day2 = val.day2Locked || false;
            adminLockState.day3 = val.day3Locked || false;
        } else {
            // åˆå§‹åŒ–
            adminLockState = { day2: false, day3: false };
        }
        
        // è³‡æ–™åº«è®Šå‹•æ™‚ï¼Œç«‹å³æ›´æ–° UI (åŒ…å«å‰å°è¼¸å…¥æ¡†å’Œå¾Œå°æŒ‰éˆ•)
        updateAllUI();
    });

    // å®šæ™‚å™¨ (æ¯ç§’æª¢æŸ¥æ™‚é–“)
    setInterval(updateAllUI, 1000);

    // çµ±ä¸€ UI æ›´æ–°å‡½å¼
    function updateAllUI() {
        const now = new Date().getTime();

        ['day2', 'day3'].forEach(day => {
            const distance = DEADLINES[day] - now;
            
            // åˆ¤æ–·æ˜¯å¦è¢«é–å®š (æ™‚é–“åˆ° OR ç®¡ç†å“¡å¼·åˆ¶é–)
            const isTimeUp = distance < 0;
            const isAdminLocked = adminLockState[day];
            const isFinalLocked = isTimeUp || isAdminLocked;

            // --- æ›´æ–°å‰å° ---
            const timerElem = document.getElementById(`timer-${day}`);
            const inputElem = document.getElementById(`input-${day}`);
            const statusElem = document.getElementById(`status-${day}`);

            if (isFinalLocked) {
                inputElem.disabled = true;
                statusElem.classList.add('text-danger');
                statusElem.innerText = isAdminLocked ? "â›” ç®¡ç†å“¡å·²æš«åœé»é¤" : "ğŸ›‘ å·²æˆªæ­¢";
                
                if (isAdminLocked) {
                    timerElem.innerText = "æš«åœé»é¤ä¸­";
                } else {
                    timerElem.innerText = "æ™‚é–“å·²åˆ°";
                }
            } else {
                // å¦‚æœæ²’è¢«é–ï¼Œç¢ºä¿å¯ä»¥è¼¸å…¥ (è§£æ±ºã€Œè§£é–å¾Œæ²’åæ‡‰ã€çš„å•é¡Œ)
                inputElem.disabled = false;
                statusElem.classList.remove('text-danger');
                statusElem.innerText = "é–‹æ”¾é»é¤ä¸­";

                // é¡¯ç¤ºå€’æ•¸æ™‚é–“
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerElem.innerText = `${days}å¤© ${hours}æ™‚ ${minutes}åˆ† ${seconds}ç§’`;
            }

            // --- æ›´æ–°å¾Œå°æŒ‰éˆ•ç‹€æ…‹ ---
            const adminBtn = document.getElementById(`admin-btn-${day}`);
            if (adminBtn) {
                if (isAdminLocked) {
                    adminBtn.innerText = `DAY ${day.slice(-1)}ï¼šå·²å¼·åˆ¶é–å®š (é»æ“Šè§£é–)`;
                    adminBtn.className = "btn btn-danger w-100";
                } else {
                    adminBtn.innerText = `DAY ${day.slice(-1)}ï¼šé–‹æ”¾ä¸­ (é»æ“Šé–å®š)`;
                    adminBtn.className = "btn btn-success w-100";
                }
            }
        });
    }

    // ================== å‰å°åŠŸèƒ½ ==================

    function submitOrder() {
        const name = document.getElementById('user-name').value.trim();
        const d2 = document.getElementById('input-day2').value.trim();
        const d3 = document.getElementById('input-day3').value.trim();

        if (!name) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }

        // æª¢æŸ¥é–å®šç‹€æ…‹ï¼Œé˜²æ­¢é§­å®¢æˆ–å»¶é²é€å‡º
        if (document.getElementById('input-day2').disabled && d2 !== "") {
            alert("DAY 2 å·²ç¶“æˆªæ­¢ï¼Œç„¡æ³•é€å‡ºè©²æ¬„ä½ã€‚");
            return;
        }
        if (document.getElementById('input-day3').disabled && d3 !== "") {
            alert("DAY 3 å·²ç¶“æˆªæ­¢ï¼Œç„¡æ³•é€å‡ºè©²æ¬„ä½ã€‚");
            return;
        }

        // å¯«å…¥ Firebase
        // ä½¿ç”¨ update è€Œä¸æ˜¯ setï¼Œé€™æ¨£å¦‚æœåªæ”¹å…¶ä¸­ä¸€å¤©ï¼Œå¦ä¸€å¤©ä¸æœƒè¢«æ¸…ç©º (è¦–éœ€æ±‚è€Œå®šï¼Œé€™è£¡ç”¨ update è¼ƒå®‰å…¨)
        const updates = {};
        if (!document.getElementById('input-day2').disabled) updates['day2'] = d2;
        if (!document.getElementById('input-day3').disabled) updates['day3'] = d3;
        
        // åŠ ä¸Šæ™‚é–“æˆ³è¨˜
        updates['lastUpdated'] = new Date().toLocaleString();

        db.ref('orders/' + name).update(updates)
            .then(() => {
                alert("âœ… è¨‚å–®å·²é€å‡º/æ›´æ–°ï¼");
            })
            .catch((error) => {
                alert("âŒ é€å‡ºå¤±æ•—ï¼š" + error.message);
            });
    }

    // ================== å¾Œå°åŠŸèƒ½ ==================

    // 1. ç™»å…¥å¾Œå°
    function checkAdminPassword() {
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
        if (pwd === "8888") { // æ‚¨å¯ä»¥è‡ªè¡Œä¿®æ”¹å¯†ç¢¼
            document.getElementById('frontend-app').style.display = 'none';
            document.getElementById('backend-dashboard').style.display = 'block';
            
            // è¼‰å…¥è¨‚å–®è³‡æ–™
            initBackendData();
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤");
        }
    }

    // 2. ç™»å‡º
    function logoutBackend() {
        document.getElementById('backend-dashboard').style.display = 'none';
        document.getElementById('frontend-app').style.display = 'block';
    }

    // 3. åˆ‡æ›é–å®šç‹€æ…‹ (å¯«å…¥ Firebase)
    function toggleAdminLock(day) {
        // è®€å–ç•¶å‰ç‹€æ…‹ä¸¦åè½‰
        const currentStatus = adminLockState[day];
        const newStatus = !currentStatus;

        // æ›´æ–°è³‡æ–™åº« (é€™æœƒè§¸ç™¼ä¸Šé¢çš„ .on('value') ç›£è½å™¨ï¼Œé€²è€Œæ›´æ–° UI)
        db.ref('adminSettings').update({
            [`${day}Locked`]: newStatus
        }).then(() => {
            console.log(`${day} lock status updated to ${newStatus}`);
        }).catch(err => {
            alert("æ›´æ–°å¤±æ•—ï¼š" + err.message);
        });
    }

    // 4. è¼‰å…¥ä¸¦ç›£è½è¨‚å–®è³‡æ–™
    function initBackendData() {
        const listContainer = document.getElementById('all-orders-list');
        
        db.ref('orders').on('value', (snapshot) => {
            listContainer.innerHTML = "";
            cachedOrders = snapshot.val() || {}; // å­˜å…¥å¿«å–ä¾›çµ±è¨ˆä½¿ç”¨
            
            const count = Object.keys(cachedOrders).length;
            document.getElementById('order-count').innerText = `${count} ç­†è¨‚å–®`;

            if (count === 0) {
                listContainer.innerHTML = "<p class='text-center text-muted'>å°šç„¡è³‡æ–™</p>";
                return;
            }

            Object.entries(cachedOrders).forEach(([name, data]) => {
                const card = document.createElement('div');
                card.className = "backend-card";
                card.innerHTML = `
                    <h5 class="fw-bold">ğŸ‘¤ ${name}</h5>
                    <div class="row">
                        <div class="col-6">
                            <span class="badge bg-primary mb-1">DAY 2</span>
                            <div class="text-dark">${data.day2 || '<span class="text-muted">æœªå¡«</span>'}</div>
                        </div>
                        <div class="col-6">
                            <span class="badge bg-info text-dark mb-1">DAY 3</span>
                            <div class="text-dark">${data.day3 || '<span class="text-muted">æœªå¡«</span>'}</div>
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2 text-end">æ›´æ–°æ–¼: ${data.lastUpdated || 'æœªçŸ¥'}</small>
                `;
                listContainer.appendChild(card);
            });
        });
    }

    // 5. çµ±è¨ˆåŠŸèƒ½
    function calculateTotals(day) {
        const resultDiv = document.getElementById('stats-result');
        const counts = {};
        let totalItems = 0;

        // éæ­·å¿«å–çš„è¨‚å–®
        Object.values(cachedOrders).forEach(order => {
            const itemsStr = order[day];
            if (itemsStr && itemsStr.trim() !== "") {
                // æ”¯æ´ç”¨é€—è™Ÿã€é “è™Ÿæˆ–ç©ºæ ¼åˆ†éš”å¤šå€‹é¤é» (ä¾‹å¦‚ "ç‰›è‚‰éºµ, å¥¶èŒ¶")
                const items = itemsStr.split(/[,ï¼Œ\s]+/);
                
                items.forEach(item => {
                    const itemName = item.trim();
                    if (itemName) {
                        counts[itemName] = (counts[itemName] || 0) + 1;
                        totalItems++;
                    }
                });
            }
        });

        // é¡¯ç¤ºçµæœ
        if (totalItems === 0) {
            resultDiv.innerHTML = `<h5 class="text-center">å°šç„¡ ${day.toUpperCase()} è³‡æ–™</h5>`;
            return;
        }

        let html = `<h5 class="text-primary border-bottom pb-2">ğŸ“Š ${day.toUpperCase()} çµ±è¨ˆçµæœ</h5>`;
        html += `<ul class="list-group list-group-flush">`;
        
        for (const [name, count] of Object.entries(counts)) {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${name}
                        <span class="badge bg-primary rounded-pill">${count}</span>
                     </li>`;
        }
        html += `</ul>`;
        html += `<div class="mt-3 text-end fw-bold">ç¸½ä»½æ•¸: ${totalItems}</div>`;
        
        resultDiv.innerHTML = html;
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹é»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f8f9fa; padding-bottom: 100px; }
        .container { max-width: 900px; margin-top: 20px; }
        
        /* åœ–ç‰‡èœå–®å¡ç‰‡æ¨£å¼ */
        .menu-item-card { 
            border: 1px solid #ddd; 
            border-radius: 12px; 
            overflow: hidden; 
            background: white;
            transition: transform 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .menu-item-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .menu-img { 
            width: 100%; 
            height: 160px; 
            object-fit: cover; 
            background-color: #f0f0f0;
        }
        .menu-body { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .menu-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        
        /* æ•¸é‡æ§åˆ¶å™¨ */
        .quantity-control { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            margin-top: auto; 
        }
        .qty-btn { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: 1px solid #ced4da; 
            background: #fff; 
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 32px;
            padding: 0;
            color: #0d6efd;
            transition: all 0.2s;
        }
        .qty-btn:active { background: #e9ecef; transform: scale(0.95); }
        .qty-btn:disabled { color: #ccc; border-color: #eee; cursor: not-allowed; }
        .qty-display { min-width: 30px; font-weight: bold; font-size: 1.2rem; }

        /* åˆ†é¡æ¨™é¡Œæ¨£å¼ */
        .category-header {
            width: 100%;
            background-color: #e3f2fd;
            color: #0d6efd;
            padding: 10px 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            border-left: 5px solid #0d6efd;
        }
        
        /* åˆ†é æŒ‰éˆ•æ¨£å¼ (å¤§æŒ‰éˆ•) */
        .nav-pills { gap: 10px; }
        .nav-pills .nav-link { 
            border-radius: 10px; 
            padding: 15px; 
            background-color: #e9ecef;
            color: #495057;
            border: 2px solid transparent;
            text-align: center;
        }
        .nav-pills .nav-link.active { 
            background-color: #fff; 
            color: #0d6efd; 
            border-color: #0d6efd;
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.1);
        }
        .timer-text {
            display: block;
            font-size: 0.9rem;
            margin-top: 5px;
            color: #dc3545;
            font-weight: bold;
        }

        /* åº•éƒ¨å›ºå®šé€å‡ºåˆ— */
        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            border-top: 1px solid #eee;
        }

        /* é–å®šé®ç½© */
        .locked-overlay { position: relative; opacity: 0.6; pointer-events: none; }
        .tab-pane.locked-overlay::before {
            content: "";
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="frontend-app" class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">ğŸšŒ æ—…éŠè¡Œç¨‹é»é¤ç³»çµ±</h2>
        <a href="index.html" class="btn btn-outline-secondary btn-sm">â†© è¿”å›è¡Œç¨‹è¡¨</a>
    </div>

    <div class="card p-4 mb-4 shadow-sm" style="border-left: 5px solid #ffc107;">
        <label class="form-label fw-bold fs-5">ğŸ  è«‹å…ˆé¸æ“‡æ‚¨çš„å®¶åº­ä»£è™Ÿï¼š</label>
        <select id="user-select" class="form-select form-select-lg" onchange="loadUserOrder()">
            <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
            </select>
    </div>

    <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link w-100 active" id="pills-day2-tab" data-bs-toggle="pill" data-bs-target="#pills-day2" type="button" role="tab">
                <div class="fs-5 fw-bold">DAY 2 (2/20)<br>å¼å¼Œ-å’ŒèŒ—åœ’</div>
                <span id="timer-day2" class="timer-text">è¨ˆç®—ä¸­...</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link w-100" id="pills-day3-tab" data-bs-toggle="pill" data-bs-target="#pills-day3" type="button" role="tab">
                <div class="fs-5 fw-bold">DAY 3 (2/21)<br>æ‰“è²“å»šæˆ¿</div>
                <span id="timer-day3" class="timer-text">è¨ˆç®—ä¸­...</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-day2" role="tabpanel">
            <div id="menu-container-day2" class="row g-3">
                </div>
        </div>
        
        <div class="tab-pane fade" id="pills-day3" role="tabpanel">
            <div id="menu-container-day3" class="row g-3">
                </div>
        </div>
    </div>

    <div class="fixed-bottom-bar">
        <div class="container" style="max-width: 900px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="current-selection-info" class="text-primary fw-bold">å°šæœªé¸æ“‡é¤é»</span>
                <small class="text-muted" id="status-msg"></small>
            </div>
            <button onclick="submitOrder()" class="btn btn-primary w-100 btn-lg shadow rounded-pill">ç¢ºèªé€å‡º / æ›´æ–°è¨‚å–® âœ…</button>
        </div>
    </div>

    <div class="text-center mt-5 mb-5">
        <button onclick="checkAdminPassword()" class="btn btn-link text-secondary btn-sm" style="text-decoration: none;">ğŸ”’ ç®¡ç†å“¡å¾Œå°</button>
    </div>
</div>

<div id="backend-dashboard" style="display: none; background-color: #e9ecef; padding: 30px; min-height: 100vh;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>âš™ï¸ å¾Œå°ç®¡ç†çµ±æ•´</h2>
            <button onclick="logoutBackend()" class="btn btn-danger">è¿”å›å‰å°</button>
        </div>

        <div class="card p-3 mb-4">
            <h4>ğŸ”’ é–å®šæ§åˆ¶</h4>
            <div class="d-flex gap-3">
                <button id="admin-btn-day2" onclick="toggleAdminLock('day2')" class="btn btn-secondary w-50">è®€å–ä¸­...</button>
                <button id="admin-btn-day3" onclick="toggleAdminLock('day3')" class="btn btn-secondary w-50">è®€å–ä¸­...</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card p-3 mb-3">
                    <h4>ğŸ“‹ å„å®¶é»é¤æ˜ç´°</h4>
                    <div id="all-orders-list" style="max-height: 500px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-3">
                    <h4>ğŸ“Š æ•¸é‡çµ±è¨ˆ</h4>
                    <button onclick="calculateTotals('day2')" class="btn btn-warning mb-2 w-100">çµ±è¨ˆ DAY 2 (å¼å¼Œ)</button>
                    <button onclick="calculateTotals('day3')" class="btn btn-info w-100">çµ±è¨ˆ DAY 3 (æ‰“è²“)</button>
                    <div id="stats-result" class="mt-3 p-2 border bg-white rounded"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================== 1. è³‡æ–™è¨­å®šå€ ==================
    
    // å®¶åº­ä»£è™Ÿæ¸…å–® (å·²æ›´æ–°)
    const FAMILIES = ["å¤ªå¹³", "ç²å®¶", "æå®¶", "è‘µå®¶", "Judyå®¶", "Jillå®¶"];

    // èœå–®è³‡æ–™
    const MENU_DATA = {
        // DAY 2: å¼å¼Œ-å’ŒèŒ—åœ’ (è«‹åœ¨æ­¤è™•å¡«å…¥çœŸå¯¦èœå–®ï¼Œç›®å‰ä½¿ç”¨ç¯„ä¾‹)
        day2: [
            { id: "d2_1", category: "ä¸»é£Ÿ", name: "æ‹›ç‰Œé¤é»ç¯„ä¾‹ A", img: "https://placehold.co/300x200?text=Menu+A" },
            { id: "d2_2", category: "ä¸»é£Ÿ", name: "æ‹›ç‰Œé¤é»ç¯„ä¾‹ B", img: "https://placehold.co/300x200?text=Menu+B" },
            { id: "d2_3", category: "é£²å“", name: "å†·æ³¡èŒ¶", img: "https://placehold.co/300x200?text=Tea" }
        ],
        // DAY 3: æ‰“è²“å»šæˆ¿ (å·²ä¾ç…§æ‚¨çš„éœ€æ±‚å®Œæ•´å»ºç«‹)
        day3: [
            // (1) æ‰“è²“é›ç¿…
            { id: "d3_w1", category: "ğŸ— (1) æ‰“è²“é›ç¿…", name: "åŸå‘³é›ç¿…", img: "https://placehold.co/300x200?text=Original+Wings" },
            { id: "d3_w2", category: "ğŸ— (1) æ‰“è²“é›ç¿…", name: "æ˜¯æ‹‰å·®é›ç¿…", img: "https://placehold.co/300x200?text=Sriracha+Wings" },
            
            // (2) ä¸»é¤
            { id: "d3_m1", category: "ğŸ¥ª (2) ä¸»é¤", name: "è²»åŸç‰›è‚‰èµ·å¸ä¸‰æ˜æ²»", img: "https://placehold.co/300x200?text=Philly+Cheesesteak" },
            { id: "d3_m2", category: "ğŸ¥ª (2) ä¸»é¤", name: "æ…¢çƒ¤æ‰‹æ’•è±¬ä¸‰æ˜æ²»", img: "https://placehold.co/300x200?text=Pulled+Pork" },
            { id: "d3_m3", category: "ğŸ¥ª (2) ä¸»é¤", name: "çƒ¤è¿·è¿­é¦™é›è…¿æ’ä¸‰æ˜æ²»", img: "https://placehold.co/300x200?text=Rosemary+Chicken" },

            // (3) é£²æ–™
            { id: "d3_d1", category: "ğŸ¥¤ (3) é£²æ–™", name: "å¯æ¨‚", img: "https://placehold.co/300x200?text=Coke" },
            { id: "d3_d2", category: "ğŸ¥¤ (3) é£²æ–™", name: "é›ªç¢§", img: "https://placehold.co/300x200?text=Sprite" },
            { id: "d3_d3", category: "ğŸ¥¤ (3) é£²æ–™", name: "æ‰‹æ‹‰ç”Ÿå•¤", img: "https://placehold.co/300x200?text=Draft+Beer" },
            { id: "d3_d4", category: "ğŸ¥¤ (3) é£²æ–™", name: "é®®æ¦¨æŸ³æ©™æ±", img: "https://placehold.co/300x200?text=Orange+Juice" },
            { id: "d3_d5", category: "ğŸ¥¤ (3) é£²æ–™", name: "æŸ³æ©™é³³è˜‹æ±", img: "https://placehold.co/300x200?text=Mixed+Juice" },
            { id: "d3_d6", category: "ğŸ¥¤ (3) é£²æ–™", name: "è‘¡è„æŸšæ±", img: "https://placehold.co/300x200?text=Grapefruit" },
            { id: "d3_d7", category: "ğŸ¥¤ (3) é£²æ–™", name: "é«˜å±±çƒé¾èŒ¶(ç†±)", img: "https://placehold.co/300x200?text=Hot+Oolong" },
            { id: "d3_d8", category: "ğŸ¥¤ (3) é£²æ–™", name: "é«˜å±±çƒé¾èŒ¶(å†°)", img: "https://placehold.co/300x200?text=Iced+Oolong" },
            { id: "d3_d9", category: "ğŸ¥¤ (3) é£²æ–™", name: "èœœé¦™ç´…èŒ¶(ç†±)", img: "https://placehold.co/300x200?text=Hot+Black+Tea" },
            { id: "d3_d10", category: "ğŸ¥¤ (3) é£²æ–™", name: "èœœé¦™ç´…èŒ¶(å†°)", img: "https://placehold.co/300x200?text=Iced+Black+Tea" },
            { id: "d3_d11", category: "ğŸ¥¤ (3) é£²æ–™", name: "æ·±ç„™æ‰‹æ²–ç¾å¼å’–å•¡(ç†±)", img: "https://placehold.co/300x200?text=Hot+Americano" },
            { id: "d3_d12", category: "ğŸ¥¤ (3) é£²æ–™", name: "æ·±ç„™æ‰‹æ²–ç¾å¼å’–å•¡(å†°)", img: "https://placehold.co/300x200?text=Iced+Americano" },
            { id: "d3_d13", category: "ğŸ¥¤ (3) é£²æ–™", name: "å–®å“æ‰‹æ²–æ·ºç„™èŒ‰é¦™æŸš(ç†±)", img: "https://placehold.co/300x200?text=Hot+Coffee" },
            { id: "d3_d14", category: "ğŸ¥¤ (3) é£²æ–™", name: "å–®å“æ‰‹æ²–æ·ºç„™èŒ‰é¦™æŸš(å†°)", img: "https://placehold.co/300x200?text=Iced+Coffee" },
            { id: "d3_d15", category: "ğŸ¥¤ (3) é£²æ–™", name: "åŸå‘³é¦™è‰å¥¶æ˜”", img: "https://placehold.co/300x200?text=Vanilla+Shake" },
            { id: "d3_d16", category: "ğŸ¥¤ (3) é£²æ–™", name: "é¦™è•‰å¥¶æ˜”", img: "https://placehold.co/300x200?text=Banana+Shake" },
            { id: "d3_d17", category: "ğŸ¥¤ (3) é£²æ–™", name: "å·§å…‹åŠ›å¥¶æ˜”", img: "https://placehold.co/300x200?text=Choco+Shake" }
        ]
    };

    // æˆªæ­¢æ™‚é–“
    const DEADLINES = {
        day2: new Date('2026-02-20T10:30:00').getTime(),
        day3: new Date('2026-02-21T10:30:00').getTime()
    };

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyC_S8VS1Tgtjdh2eyavGR3jN2BmWF_Etg4",
        authDomain: "tainan-trip-order.firebaseapp.com",
        databaseURL: "https://tainan-trip-order-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tainan-trip-order",
        storageBucket: "tainan-trip-order.firebasestorage.app",
        messagingSenderId: "171271367128",
        appId: "1:171271367128:web:91d2cb419a35902dec2aad",
        measurementId: "G-Y8P3XCTS1Q"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================== æ ¸å¿ƒé‚è¼¯ ==================
    let currentOrders = { day2: {}, day3: {} };
    let adminLockState = { day2: false, day3: false };
    let cachedOrders = {};

    // 1. åˆå§‹åŒ–å®¶åº­é¸å–®
    const selectElem = document.getElementById('user-select');
    FAMILIES.forEach(fam => {
        const opt = document.createElement('option');
        opt.value = fam;
        opt.innerText = fam;
        selectElem.appendChild(opt);
    });

    // 2. æ¸²æŸ“èœå–® (å«åˆ†é¡æ¨™é¡ŒåŠŸèƒ½)
    function renderMenu(day, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        
        let lastCategory = "";

        MENU_DATA[day].forEach(item => {
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ’å…¥åˆ†é¡æ¨™é¡Œ
            if (item.category && item.category !== lastCategory) {
                const header = document.createElement('div');
                header.className = "category-header";
                header.innerText = item.category;
                container.appendChild(header);
                lastCategory = item.category;
            }

            const col = document.createElement('div');
            col.className = "col-6 col-md-4 col-lg-3"; // éŸ¿æ‡‰å¼æ’ç‰ˆ
            col.innerHTML = `
                <div class="menu-item-card">
                    <img src="${item.img}" class="menu-img" alt="${item.name}">
                    <div class="menu-body">
                        <div class="menu-title">${item.name}</div>
                        <div class="quantity-control">
                            <button class="qty-btn" onclick="updateQty('${day}', '${item.id}', -1)">-</button>
                            <span id="qty-${item.id}" class="qty-display text-primary">0</span>
                            <button class="qty-btn" onclick="updateQty('${day}', '${item.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(col);
        });
    }

    renderMenu('day2', 'menu-container-day2');
    renderMenu('day3', 'menu-container-day3');

    // 3. æ›´æ–°æ•¸é‡
    window.updateQty = function(day, itemId, delta) {
        if (isDayLocked(day)) {
            alert("è©²å¤©å·²æˆªæ­¢é»é¤ï¼Œç„¡æ³•ä¿®æ”¹ï¼");
            return;
        }
        if (!currentOrders[day]) currentOrders[day] = {};

        let currentQty = currentOrders[day][itemId] || 0;
        let newQty = currentQty + delta;
        if (newQty < 0) newQty = 0;

        currentOrders[day][itemId] = newQty;
        document.getElementById(`qty-${itemId}`).innerText = newQty;
        
        updateBottomInfo();
    }

    // 4. æ›´æ–°åº•éƒ¨è³‡è¨Š
    function updateBottomInfo() {
        let total = 0;
        ['day2', 'day3'].forEach(d => {
            Object.values(currentOrders[d] || {}).forEach(q => total += q);
        });
        
        const info = document.getElementById('current-selection-info');
        info.innerText = total > 0 ? `ç›®å‰ç¸½è¨ˆå·²é¸ ${total} ä»½é¤é»` : "å°šæœªé¸æ“‡é¤é»";
    }

    // 5. é–å®šé‚è¼¯èˆ‡å€’æ•¸ (æ›´æ–°è‡³æŒ‰éˆ•å…§)
    function isDayLocked(day) {
        const now = new Date().getTime();
        return (DEADLINES[day] - now < 0) || adminLockState[day];
    }

    function updateLockUI() {
        const now = new Date().getTime();

        ['day2', 'day3'].forEach(day => {
            const distance = DEADLINES[day] - now;
            const timerElem = document.getElementById(`timer-${day}`);
            const locked = isDayLocked(day);
            const container = document.getElementById(`pills-${day}`);
            
            // æ›´æ–°æŒ‰éˆ•å…§çš„æ–‡å­—
            if (locked) {
                if (adminLockState[day]) {
                    timerElem.innerText = "â›” ç®¡ç†å“¡å·²æš«åœé»é¤";
                } else {
                    timerElem.innerText = "ğŸ›‘ å·²æˆªæ­¢é»é¤";
                }
                
                // é–å®šè¦–è¦ºæ•ˆæœ
                if (!container.classList.contains('locked-overlay')) {
                    container.classList.add('locked-overlay');
                    container.querySelectorAll('.qty-btn').forEach(b => b.disabled = true);
                }
            } else {
                const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                // åˆ†é˜æ•¸å°æ–¼ 10 è£œ 0
                const mm = m < 10 ? '0' + m : m;
                timerElem.innerText = `â³ å‰©é¤˜ ${d}å¤© ${h}æ™‚ ${mm}åˆ†`;
                
                // è§£é–
                container.classList.remove('locked-overlay');
                container.querySelectorAll('.qty-btn').forEach(b => b.disabled = false);
            }
        });
    }

    // Firebase ç›£è½é–å®š
    db.ref('adminSettings').on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            adminLockState.day2 = val.day2Locked || false;
            adminLockState.day3 = val.day3Locked || false;
        }
        updateLockUI();
    });

    setInterval(updateLockUI, 1000);

    // ================== è³‡æ–™å­˜å– ==================

    // è¼‰å…¥ä½¿ç”¨è€…è¨‚å–®
    window.loadUserOrder = function() {
        const user = document.getElementById('user-select').value;
        if (!user) return;

        // é‡ç½®ç•«é¢
        document.querySelectorAll('[id^="qty-"]').forEach(el => el.innerText = "0");
        currentOrders = { day2: {}, day3: {} };

        db.ref('orders/' + user).once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
                parseOrderToUI('day2', data.day2);
                parseOrderToUI('day3', data.day3);
            }
            updateBottomInfo();
        });
    }

    function parseOrderToUI(day, str) {
        if (!str) return;
        const items = str.split(', ');
        items.forEach(part => {
            MENU_DATA[day].forEach(menuItem => {
                if (part.includes(menuItem.name)) {
                    const parts = part.split(' x ');
                    if (parts.length === 2) {
                        const qty = parseInt(parts[1]);
                        currentOrders[day][menuItem.id] = qty;
                        const el = document.getElementById(`qty-${menuItem.id}`);
                        if(el) el.innerText = qty;
                    }
                }
            });
        });
    }

    // é€å‡ºè¨‚å–®
    window.submitOrder = function() {
        const user = document.getElementById('user-select').value;
        if (!user) { alert("è«‹å…ˆé¸æ“‡å®¶åº­ä»£è™Ÿï¼"); return; }

        const d2Str = generateStr('day2');
        const d3Str = generateStr('day3');

        if (!d2Str && !d3Str) {
            if(!confirm("å…©å¤©çš†æœªé»é¤ï¼Œç¢ºå®šè¦é€å‡ºç©ºç™½è¨‚å–®å—ï¼Ÿ")) return;
        }

        const updates = {};
        if (!isDayLocked('day2')) updates['day2'] = d2Str;
        if (!isDayLocked('day3')) updates['day3'] = d3Str;
        updates['lastUpdated'] = new Date().toLocaleString();

        db.ref('orders/' + user).update(updates)
            .then(() => alert("âœ… è¨‚å–®æ›´æ–°æˆåŠŸï¼"))
            .catch(err => alert("å¤±æ•—ï¼š" + err.message));
    }

    function generateStr(day) {
        const orders = currentOrders[day];
        if (!orders) return "";
        let res = [];
        for (const [id, qty] of Object.entries(orders)) {
            if (qty > 0) {
                const item = MENU_DATA[day].find(m => m.id === id);
                if (item) res.push(`${item.name} x ${qty}`);
            }
        }
        return res.join(", ");
    }

    // ================== å¾Œå° JS ==================
    window.checkAdminPassword = function() {
        if (prompt("å¯†ç¢¼ï¼š") === "8888") {
            document.getElementById('frontend-app').style.display = 'none';
            document.getElementById('backend-dashboard').style.display = 'block';
            initBackend();
        } else alert("éŒ¯èª¤");
    }

    window.logoutBackend = function() {
        document.getElementById('backend-dashboard').style.display = 'none';
        document.getElementById('frontend-app').style.display = 'block';
    }

    window.toggleAdminLock = function(day) {
        db.ref('adminSettings').update({ [`${day}Locked`]: !adminLockState[day] });
    }

    function initBackend() {
        const list = document.getElementById('all-orders-list');
        db.ref('orders').on('value', sn => {
            list.innerHTML = "";
            cachedOrders = sn.val() || {};
            if(!cachedOrders) { list.innerHTML="ç„¡è³‡æ–™"; return; }
            
            Object.entries(cachedOrders).forEach(([name, d]) => {
                const div = document.createElement('div');
                div.className = "card mb-2 p-2";
                div.innerHTML = `<strong>${name}</strong><br>
                                 <small class="text-primary">D2: ${d.day2||'-'}</small><br>
                                 <small class="text-success">D3: ${d.day3||'-'}</small>`;
                list.appendChild(div);
            });

            ['day2', 'day3'].forEach(d => {
                const btn = document.getElementById(`admin-btn-${d}`);
                const isLocked = adminLockState[d];
                btn.innerText = isLocked ? `${d.toUpperCase()} å·²é–å®š (æŒ‰æ­¤è§£é–)` : `${d.toUpperCase()} é–‹æ”¾ä¸­ (æŒ‰æ­¤é–å®š)`;
                btn.className = isLocked ? "btn btn-danger w-50" : "btn btn-success w-50";
            });
        });
    }

    window.calculateTotals = function(day) {
        const div = document.getElementById('stats-result');
        let counts = {};
        Object.values(cachedOrders).forEach(o => {
            const s = o[day];
            if(s) s.split(', ').forEach(p => {
                const [n, q] = p.split(' x ');
                if(n && q) counts[n] = (counts[n]||0) + parseInt(q);
            });
        });
        
        let h = `<h6>${day.toUpperCase()} çµ±è¨ˆ</h6><ul class="list-group">`;
        for(const [n, c] of Object.entries(counts)) {
            h += `<li class="list-group-item d-flex justify-content-between"><span>${n}</span> <span class="badge bg-primary rounded-pill">${c}</span></li>`;
        }
        h += "</ul>";
        div.innerHTML = h;
    }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹é»é¤ç³»çµ± (åœ–ç‰‡ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f8f9fa; padding-bottom: 80px; }
        .container { max-width: 800px; margin-top: 20px; }
        
        /* åœ–ç‰‡èœå–®æ¨£å¼ */
        .menu-item-card { 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            overflow: hidden; 
            background: white;
            transition: transform 0.2s;
            height: 100%;
        }
        .menu-item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .menu-img { 
            width: 100%; 
            height: 150px; 
            object-fit: cover; 
            background-color: #eee;
        }
        .menu-body { padding: 15px; text-align: center; }
        .quantity-control { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            margin-top: 10px; 
        }
        .qty-btn { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            border: 1px solid #ced4da; 
            background: #fff; 
            font-weight: bold;
            line-height: 28px;
            padding: 0;
        }
        .qty-btn:active { background: #e9ecef; }
        
        /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .nav-pills .nav-link { 
            border-radius: 50px; 
            padding: 10px 25px; 
            font-weight: bold; 
            margin: 0 5px;
            color: #6c757d;
            background-color: #e9ecef;
        }
        .nav-pills .nav-link.active { 
            background-color: #0d6efd; 
            color: white; 
        }
        .tab-content { padding: 20px 0; }

        /* é–å®šé®ç½© */
        .locked-overlay {
            position: relative;
        }
        .locked-overlay::after {
            content: "â›” å·²é–å®šç„¡æ³•é»é¤";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #dc3545;
            font-weight: bold;
            z-index: 10;
            border-radius: 10px;
        }

        /* åº•éƒ¨å›ºå®šé€å‡ºæŒ‰éˆ• */
        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="frontend-app" class="container">
    <h2 class="text-center mb-3">ğŸšŒ æ—…éŠè¡Œç¨‹é»é¤ç³»çµ±</h2>

    <div class="card p-3 mb-3">
        <label class="form-label fw-bold">ğŸ  è«‹é¸æ“‡å®¶åº­ä»£è™Ÿ / å§“åï¼š</label>
        <select id="user-select" class="form-select form-select-lg" onchange="loadUserOrder()">
            <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
            </select>
    </div>

    <div class="alert alert-info text-center py-2 mb-3">
        <small class="d-block text-muted">é»é¤å€’æ•¸</small>
        <div class="d-flex justify-content-center gap-4 fw-bold">
            <span id="timer-day2">DAY 2: è¨ˆç®—ä¸­...</span>
            <span id="timer-day3">DAY 3: è¨ˆç®—ä¸­...</span>
        </div>
    </div>

    <ul class="nav nav-pills justify-content-center mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-day2-tab" data-bs-toggle="pill" data-bs-target="#pills-day2" type="button" role="tab">DAY 2 (2/20)</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-day3-tab" data-bs-toggle="pill" data-bs-target="#pills-day3" type="button" role="tab">DAY 3 (2/21)</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-day2" role="tabpanel">
            <div id="menu-container-day2" class="row g-3">
                </div>
        </div>
        
        <div class="tab-pane fade" id="pills-day3" role="tabpanel">
            <div id="menu-container-day3" class="row g-3">
                </div>
        </div>
    </div>

    <div class="fixed-bottom-bar">
        <div class="container" style="max-width: 800px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="current-selection-info" class="text-primary fw-bold small">å°šæœªé¸æ“‡é¤é»</span>
            </div>
            <button onclick="submitOrder()" class="btn btn-primary w-100 btn-lg shadow">ç¢ºèªé€å‡º / æ›´æ–°è¨‚å–®</button>
        </div>
    </div>

    <div class="text-center mt-5 mb-5">
        <button onclick="checkAdminPassword()" class="btn btn-link text-secondary btn-sm" style="text-decoration: none;">ğŸ”’ ç®¡ç†å“¡å¾Œå°</button>
    </div>
</div>

<div id="backend-dashboard" style="display: none; background-color: #e9ecef; padding: 30px; min-height: 100vh;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>âš™ï¸ å¾Œå°ç®¡ç†çµ±æ•´</h2>
            <button onclick="logoutBackend()" class="btn btn-danger">è¿”å›å‰å°</button>
        </div>

        <div class="card p-3 mb-4">
            <h4>å¼·åˆ¶é–å®šæ§åˆ¶</h4>
            <div class="d-flex gap-3">
                <button id="admin-btn-day2" onclick="toggleAdminLock('day2')" class="btn btn-secondary">è®€å–ä¸­...</button>
                <button id="admin-btn-day3" onclick="toggleAdminLock('day3')" class="btn btn-secondary">è®€å–ä¸­...</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card p-3">
                    <h4>ğŸ“‹ å„å®¶é»é¤æ˜ç´°</h4>
                    <div id="all-orders-list" style="max-height: 500px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-3">
                    <h4>ğŸ“Š æ•¸é‡çµ±è¨ˆ</h4>
                    <button onclick="calculateTotals('day2')" class="btn btn-warning mb-2 w-100">çµ±è¨ˆ DAY 2</button>
                    <button onclick="calculateTotals('day3')" class="btn btn-info w-100">çµ±è¨ˆ DAY 3</button>
                    <div id="stats-result" class="mt-3 p-2 border bg-white"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================== 1. è³‡æ–™è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) ==================
    
    // å®¶åº­ä»£è™Ÿæ¸…å–®
    const FAMILIES = ["ç‹å°æ˜å®¶", "é™³å¤§æ–‡å®¶", "æ—é˜¿å§¨", "å¼µä¸‰è±", "æå››", "æ¸¬è©¦å“¡"];

    // èœå–®è³‡æ–™ (åœ–ç‰‡è«‹æ›æˆçœŸå¯¦ç¶²å€)
    // åœ–ç‰‡å»ºè­°æ¯”ä¾‹ 4:3 æˆ– 1:1
    const MENU_DATA = {
        day2: [
            { id: "d2_1", name: "æ‹›ç‰Œç‰›è‚‰éºµ", img: "https://placehold.co/300x200?text=Beef+Noodle" },
            { id: "d2_2", name: "æ’éª¨é£¯", img: "https://placehold.co/300x200?text=Pork+Rice" },
            { id: "d2_3", name: "é›è…¿ä¾¿ç•¶", img: "https://placehold.co/300x200?text=Chicken+Rice" },
            { id: "d2_4", name: "ç´ é£Ÿç‚’éºµ", img: "https://placehold.co/300x200?text=Veggie+Noodle" }
        ],
        day3: [
            { id: "d3_1", name: "æµ·é®®ç²¥", img: "https://placehold.co/300x200?text=Seafood+Congee" },
            { id: "d3_2", name: "ä¸‰æ˜æ²»å¥—é¤", img: "https://placehold.co/300x200?text=Sandwich" },
            { id: "d3_3", name: "æ¼¢å ¡+å¥¶èŒ¶", img: "https://placehold.co/300x200?text=Burger+Set" }
        ]
    };

    // æˆªæ­¢æ™‚é–“
    const DEADLINES = {
        day2: new Date('2026-02-20T10:30:00').getTime(),
        day3: new Date('2026-02-21T10:30:00').getTime()
    };

    // ================== Firebase è¨­å®š ==================
    const firebaseConfig = {
        apiKey: "AIzaSyC_S8VS1Tgtjdh2eyavGR3jN2BmWF_Etg4",
        authDomain: "tainan-trip-order.firebaseapp.com",
        databaseURL: "https://tainan-trip-order-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tainan-trip-order",
        storageBucket: "tainan-trip-order.firebasestorage.app",
        messagingSenderId: "171271367128",
        appId: "1:171271367128:web:91d2cb419a35902dec2aad",
        measurementId: "G-Y8P3XCTS1Q"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================== å…¨å±€ç‹€æ…‹è®Šæ•¸ ==================
    let currentOrders = { day2: {}, day3: {} }; // æš«å­˜ä½¿ç”¨è€…ç›®å‰çš„é¸æ“‡ { "d2_1": 2, "d2_2": 1 }
    let adminLockState = { day2: false, day3: false };
    let currentUserData = null; // å¾è³‡æ–™åº«è®€å–çš„èˆŠè³‡æ–™

    // ================== åˆå§‹åŒ–èˆ‡ä»‹é¢æ¸²æŸ“ ==================

    // 1. ç”¢ç”Ÿå®¶åº­é¸å–®
    const selectElem = document.getElementById('user-select');
    FAMILIES.forEach(fam => {
        const opt = document.createElement('option');
        opt.value = fam;
        opt.innerText = fam;
        selectElem.appendChild(opt);
    });

    // 2. æ¸²æŸ“èœå–®å¡ç‰‡
    function renderMenu(day, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        
        MENU_DATA[day].forEach(item => {
            const col = document.createElement('div');
            col.className = "col-6 col-md-4"; // æ‰‹æ©Ÿç‰ˆä¸€åˆ—2å€‹ï¼Œé›»è…¦ç‰ˆä¸€åˆ—3å€‹
            col.innerHTML = `
                <div class="menu-item-card h-100">
                    <img src="${item.img}" class="menu-img" alt="${item.name}">
                    <div class="menu-body">
                        <h6 class="card-title fw-bold mb-2">${item.name}</h6>
                        <div class="quantity-control">
                            <button class="qty-btn" onclick="updateQty('${day}', '${item.id}', -1)">-</button>
                            <span id="qty-${item.id}" class="fw-bold text-primary fs-5">0</span>
                            <button class="qty-btn" onclick="updateQty('${day}', '${item.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(col);
        });
    }

    renderMenu('day2', 'menu-container-day2');
    renderMenu('day3', 'menu-container-day3');

    // ================== æ ¸å¿ƒåŠŸèƒ½é‚è¼¯ ==================

    // 1. æ›´æ–°æ•¸é‡ (æŒ‰ä¸‹ + æˆ– -)
    window.updateQty = function(day, itemId, delta) {
        // æª¢æŸ¥é–å®šç‹€æ…‹
        if (isDayLocked(day)) {
            alert("è©²å¤©å·²æˆªæ­¢é»é¤ï¼Œç„¡æ³•ä¿®æ”¹ï¼");
            return;
        }
        
        // ç¢ºä¿è©²å¤©æœ‰ç‰©ä»¶
        if (!currentOrders[day]) currentOrders[day] = {};

        // è¨ˆç®—æ–°æ•¸é‡
        let currentQty = currentOrders[day][itemId] || 0;
        let newQty = currentQty + delta;
        if (newQty < 0) newQty = 0;

        // æ›´æ–°ç‹€æ…‹èˆ‡ç•«é¢
        currentOrders[day][itemId] = newQty;
        document.getElementById(`qty-${itemId}`).innerText = newQty;
        
        updateBottomInfo();
    }

    // 2. æ›´æ–°åº•éƒ¨è³‡è¨Šåˆ—
    function updateBottomInfo() {
        let totalItems = 0;
        // è¨ˆç®—ç¸½æ•¸
        ['day2', 'day3'].forEach(day => {
            Object.values(currentOrders[day] || {}).forEach(q => totalItems += q);
        });
        
        const info = document.getElementById('current-selection-info');
        if (totalItems > 0) {
            info.innerText = `ç›®å‰å·²é¸æ“‡ ${totalItems} ä»½é¤é»`;
        } else {
            info.innerText = "å°šæœªé¸æ“‡é¤é»";
        }
    }

    // 3. åˆ¤æ–·æŸå¤©æ˜¯å¦é–å®š
    function isDayLocked(day) {
        const now = new Date().getTime();
        const timeUp = (DEADLINES[day] - now) < 0;
        return timeUp || adminLockState[day];
    }

    // 4. ç›£è½ Firebase é–å®šè¨­å®š (å³æ™‚åŒæ­¥)
    db.ref('adminSettings').on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            adminLockState.day2 = val.day2Locked || false;
            adminLockState.day3 = val.day3Locked || false;
        }
        updateLockUI();
    });

    // å®šæ™‚å™¨ (æ¯ç§’æ›´æ–°å€’æ•¸)
    setInterval(() => {
        updateLockUI(); // åŒæ™‚æ›´æ–°å€’æ•¸èˆ‡ UI ç‹€æ…‹
    }, 1000);

    function updateLockUI() {
        const now = new Date().getTime();

        ['day2', 'day3'].forEach(day => {
            // è¨ˆç®—å€’æ•¸
            const distance = DEADLINES[day] - now;
            const timerElem = document.getElementById(`timer-${day}`);
            
            // åˆ¤æ–·é–å®š
            const locked = isDayLocked(day);
            const container = document.getElementById(`pills-${day}`); // Tab å…§å®¹å€
            
            // å€’æ•¸æ–‡å­—
            if (locked) {
                timerElem.innerText = `${day.toUpperCase()}: å·²æˆªæ­¢`;
                timerElem.classList.add('text-danger');
                // åŠ ä¸Šé®ç½©
                if (!container.classList.contains('locked-overlay')) {
                    container.classList.add('locked-overlay');
                    // é–å®šæ™‚ç¦ç”¨æŒ‰éˆ• (è¦–è¦ºä¸Š)
                    const btns = container.querySelectorAll('.qty-btn');
                    btns.forEach(b => b.disabled = true);
                }
            } else {
                const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                timerElem.innerText = `${day.toUpperCase()}: ${d}å¤©${h}æ™‚${m}åˆ†`;
                timerElem.classList.remove('text-danger');
                
                // è§£é™¤é®ç½©
                container.classList.remove('locked-overlay');
                const btns = container.querySelectorAll('.qty-btn');
                btns.forEach(b => b.disabled = false);
            }
        });
    }

    // ================== è³‡æ–™è®€å–èˆ‡å¯«å…¥ ==================

    // 1. è®€å–ä½¿ç”¨è€…èˆŠè¨‚å–® (ç•¶ä¸‹æ‹‰é¸å–®æ”¹è®Šæ™‚)
    window.loadUserOrder = function() {
        const user = document.getElementById('user-select').value;
        if (!user) return;

        // æ¸…ç©ºç•«é¢æ•¸å­—
        document.querySelectorAll('[id^="qty-"]').forEach(el => el.innerText = "0");
        currentOrders = { day2: {}, day3: {} }; // é‡ç½®ç‹€æ…‹

        db.ref('orders/' + user).once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
                // è§£æè³‡æ–™ (è³‡æ–™åº«å­˜çš„æ˜¯å­—ä¸² "ç‰›è‚‰éºµ x 1, æ’éª¨é£¯ x 2")
                // æˆ‘å€‘éœ€è¦åå‘è§£æå›æ•¸å­—å¡«å…¥ UI
                parseOrderStringToUI('day2', data.day2);
                parseOrderStringToUI('day3', data.day3);
            }
            updateBottomInfo();
        });
    }

    function parseOrderStringToUI(day, orderString) {
        if (!orderString) return;
        
        // æ ¼å¼ç¯„ä¾‹: "æ‹›ç‰Œç‰›è‚‰éºµ x 2, æ’éª¨é£¯ x 1"
        const items = orderString.split(', ');
        items.forEach(part => {
            // å°‹æ‰¾å°æ‡‰çš„èœå
            const menuList = MENU_DATA[day];
            menuList.forEach(menuItem => {
                if (part.includes(menuItem.name)) {
                    // æå–æ•¸é‡ (å‡è¨­æ ¼å¼å›ºå®šç‚º "Name x Qty")
                    const parts = part.split(' x ');
                    if (parts.length === 2) {
                        const qty = parseInt(parts[1]);
                        currentOrders[day][menuItem.id] = qty;
                        const qtyElem = document.getElementById(`qty-${menuItem.id}`);
                        if(qtyElem) qtyElem.innerText = qty;
                    }
                }
            });
        });
    }

    // 2. é€å‡ºè¨‚å–® (è½‰æ›å›å­—ä¸²æ ¼å¼å­˜æª”)
    window.submitOrder = function() {
        const user = document.getElementById('user-select').value;
        if (!user) { alert("è«‹å…ˆé¸æ“‡å®¶åº­ä»£è™Ÿï¼"); return; }

        // ç”¢ç”Ÿå­—ä¸²
        const strDay2 = generateOrderString('day2');
        const strDay3 = generateOrderString('day3');

        // æª¢æŸ¥æ˜¯å¦å…¨ç©º
        if (!strDay2 && !strDay3) {
            if(!confirm("æ‚¨ç›®å‰å…©å¤©éƒ½æ²’é¸ä»»ä½•é¤é»ï¼Œç¢ºå®šè¦é€å‡ºç©ºç™½è¨‚å–®å—ï¼Ÿ")) return;
        }

        // æº–å‚™æ›´æ–°è³‡æ–™
        const updates = {};
        
        // åªæœ‰åœ¨ã€Œæœªé–å®šã€çš„æƒ…æ³ä¸‹æ‰å…è¨±æ›´æ–°è©²å¤©è³‡æ–™
        // å¦‚æœ Day2 é–å®šäº†ï¼Œæˆ‘å€‘å°±ä¸é€å‡º Day2 çš„æ›´æ–°ï¼Œé¿å…è¦†è“‹èˆŠè³‡æ–™
        if (!isDayLocked('day2')) updates['day2'] = strDay2;
        if (!isDayLocked('day3')) updates['day3'] = strDay3;
        
        updates['lastUpdated'] = new Date().toLocaleString();

        db.ref('orders/' + user).update(updates)
            .then(() => alert("âœ… è¨‚å–®å·²æˆåŠŸé€å‡ºï¼"))
            .catch(err => alert("âŒ å¤±æ•—ï¼š" + err.message));
    }

    function generateOrderString(day) {
        const orders = currentOrders[day];
        if (!orders) return "";
        
        let resultParts = [];
        // éæ­·æ‰€æœ‰é¸åˆ°çš„ ID
        for (const [itemId, qty] of Object.entries(orders)) {
            if (qty > 0) {
                // æ‰¾å‡ºèœå
                const menuItem = MENU_DATA[day].find(m => m.id === itemId);
                if (menuItem) {
                    resultParts.push(`${menuItem.name} x ${qty}`);
                }
            }
        }
        return resultParts.join(", ");
    }

    // ================== å¾Œå°ç›¸é—œ JS (ä¿æŒä¸è®Š) ==================
    window.checkAdminPassword = function() {
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
        if (pwd === "8888") {
            document.getElementById('frontend-app').style.display = 'none';
            document.getElementById('backend-dashboard').style.display = 'block';
            initBackendData();
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    window.logoutBackend = function() {
        document.getElementById('backend-dashboard').style.display = 'none';
        document.getElementById('frontend-app').style.display = 'block';
    }

    window.toggleAdminLock = function(day) {
        const newStatus = !adminLockState[day];
        db.ref('adminSettings').update({ [`${day}Locked`]: newStatus });
    }

    function initBackendData() {
        const listContainer = document.getElementById('all-orders-list');
        db.ref('orders').on('value', snapshot => {
            listContainer.innerHTML = "";
            cachedOrders = snapshot.val() || {};
            
            if (Object.keys(cachedOrders).length === 0) {
                listContainer.innerHTML = "<p>ç„¡è³‡æ–™</p>"; return;
            }

            Object.entries(cachedOrders).forEach(([name, data]) => {
                const div = document.createElement('div');
                div.className = "card mb-2 p-2";
                div.innerHTML = `<strong>${name}</strong>
                                 <small>D2: ${data.day2 || '-'}</small>
                                 <small>D3: ${data.day3 || '-'}</small>`;
                listContainer.appendChild(div);
            });
            
            // æ›´æ–°å¾Œå°æŒ‰éˆ•ç‹€æ…‹
            ['day2', 'day3'].forEach(d => {
                const btn = document.getElementById(`admin-btn-${d}`);
                if(btn) btn.innerText = adminLockState[d] ? "å·²é–å®š (æŒ‰æ­¤è§£é–)" : "é–‹æ”¾ä¸­ (æŒ‰æ­¤é–å®š)";
                if(btn) btn.className = adminLockState[d] ? "btn btn-danger" : "btn btn-success";
            });
        });
    }

    // å¾Œå°çµ±è¨ˆ (å­—ä¸²è§£æç‰ˆ)
    window.calculateTotals = function(day) {
        const resultDiv = document.getElementById('stats-result');
        let counts = {};
        
        Object.values(cachedOrders).forEach(order => {
            const str = order[day];
            if (str) {
                // è§£æ "ç‰›è‚‰éºµ x 2, æ’éª¨é£¯ x 1"
                const parts = str.split(', ');
                parts.forEach(p => {
                    const [name, qtyStr] = p.split(' x ');
                    if (name && qtyStr) {
                        const q = parseInt(qtyStr);
                        counts[name] = (counts[name] || 0) + q;
                    }
                });
            }
        });

        let html = `<h6>${day} çµ±è¨ˆ</h6><ul>`;
        for (const [n, c] of Object.entries(counts)) {
            html += `<li>${n}: ${c}</li>`;
        }
        html += "</ul>";
        resultDiv.innerHTML = html;
    }
    
    // ç”¨æ–¼å¾Œå°çµ±è¨ˆçš„æš«å­˜
    let cachedOrders = {};

</script>

</body>
</html>

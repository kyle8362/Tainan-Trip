<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹é»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f8f9fa; padding-bottom: 120px; }
        .container { max-width: 900px; margin-top: 20px; }
        
        /* çµ±ä¸€ä½¿ç”¨ç„¡åœ–å¡ç‰‡æ¨£å¼ */
        .menu-item-card { 
            border: 1px solid #ddd; 
            border-radius: 12px; 
            overflow: hidden; 
            background: white;
            transition: transform 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .menu-item-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* éš±è—æ‰€æœ‰å¡ç‰‡åœ–ç‰‡ */
        .menu-img { display: none; }
        
        /* èª¿æ•´ç„¡åœ–æ¨¡å¼çš„å…§è·èˆ‡æ’åˆ— */
        .menu-body { 
            padding: 15px; 
            text-align: left; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-grow: 1;
        }
        .menu-title { font-size: 1.1rem; font-weight: bold; margin: 0; color: #333; flex: 1; }
        
        /* æ•¸é‡æ§åˆ¶å™¨ */
        .quantity-control { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            margin-left: 10px;
        }
        .qty-btn { 
            width: 32px; height: 32px; 
            border-radius: 50%; border: 1px solid #ced4da; 
            background: #fff; font-weight: bold; font-size: 1.2rem; 
            line-height: 28px; padding: 0; color: #0d6efd; 
        }
        .qty-btn:active { background: #e9ecef; }
        .qty-btn:disabled { color: #ccc; border-color: #eee; }
        .qty-display { min-width: 30px; text-align: center; font-weight: bold; font-size: 1.2rem; }

        /* åˆ†é¡æ¨™é¡Œ */
        .category-header {
            width: 100%;
            background-color: #e3f2fd;
            color: #0d6efd;
            padding: 10px 15px;
            margin-top: 25px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            border-left: 5px solid #0d6efd;
        }
        
        /* åˆ†é æŒ‰éˆ• */
        .nav-pills { gap: 10px; }
        .nav-pills .nav-link { 
            border-radius: 10px; padding: 15px; 
            background-color: #e9ecef; color: #495057; 
            text-align: center; border: 2px solid transparent;
        }
        .nav-pills .nav-link.active { 
            background-color: #fff; color: #0d6efd; 
            border-color: #0d6efd; 
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.1);
        }
        .timer-text { display: block; font-size: 0.9rem; margin-top: 5px; color: #dc3545; font-weight: bold; }

        /* åº•éƒ¨å›ºå®šåˆ— */
        .fixed-bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
            padding: 15px; box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            z-index: 1000; border-top: 1px solid #eee;
        }

        /* é–å®šé®ç½© */
        .locked-overlay { opacity: 0.6; pointer-events: none; position: relative; }
        
        /* åœ–ç‰‡ Modal æ¨£å¼ */
        .modal-img-container { text-align: center; }
        .modal-img-container img { max-width: 100%; height: auto; border-radius: 5px; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="frontend-app" class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">ğŸšŒ æ—…éŠè¡Œç¨‹é»é¤ç³»çµ±</h2>
        <a href="https://kyle8362.github.io/Tainan-Trip/" class="btn btn-outline-secondary btn-sm">â†© è¿”å›è¡Œç¨‹è¡¨</a>
    </div>

    <div class="card p-4 mb-4 shadow-sm" style="border-left: 5px solid #ffc107;">
        <label class="form-label fw-bold fs-5">ğŸ  è«‹å…ˆé¸æ“‡æ‚¨çš„å®¶åº­ä»£è™Ÿï¼š</label>
        <select id="user-select" class="form-select form-select-lg" onchange="loadUserOrder()">
            <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
        </select>
    </div>

    <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link w-100 active" id="pills-day2-tab" data-bs-toggle="pill" data-bs-target="#pills-day2" type="button" role="tab">
                <div class="fs-5 fw-bold">DAY 2 (2/20)<br>å¼å¼Œ-å’ŒèŒ—åœ’</div>
                <span id="timer-day2" class="timer-text">è¨ˆç®—ä¸­...</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link w-100" id="pills-day3-tab" data-bs-toggle="pill" data-bs-target="#pills-day3" type="button" role="tab">
                <div class="fs-5 fw-bold">DAY 3 (2/21)<br>æ‰“è²“å»šæˆ¿</div>
                <span id="timer-day3" class="timer-text">è¨ˆç®—ä¸­...</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-day2" role="tabpanel">
            
            <div class="text-center mb-3">
                <button type="button" class="btn btn-warning shadow-sm" data-bs-toggle="modal" data-bs-target="#menuImageModal">
                    ğŸ“¸ ä¸çœ‹åœ–ç‰‡ä¸æœƒé» (é»æˆ‘çœ‹èœå–®åœ–)
                </button>
            </div>

            <div id="menu-container-day2" class="row g-3">
                </div>
            
            <div class="alert alert-warning mt-3 small">
                ğŸ’¡ æé†’ï¼šæ¯ä¸€ä»½å¥—é¤è«‹å‹™å¿…åœ¨ä¸‹æ–¹ã€Œæ­é…é£²æ–™ã€å€é¸æ“‡ä¸€ä»½é£²å“ (ä¸»é¤æ•¸éœ€ç­‰æ–¼é£²æ–™æ•¸)ã€‚
            </div>
        </div>
        
        <div class="tab-pane fade" id="pills-day3" role="tabpanel">
            <div id="menu-container-day3" class="row g-3">
                </div>
        </div>
    </div>

    <div class="fixed-bottom-bar">
        <div class="container" style="max-width: 900px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="current-selection-info" class="text-primary fw-bold">å°šæœªé¸æ“‡é¤é»</span>
            </div>
            <button onclick="submitOrder()" class="btn btn-primary w-100 btn-lg shadow rounded-pill">ç¢ºèªé€å‡º / æ›´æ–°è¨‚å–® âœ…</button>
        </div>
    </div>

    <div class="text-center mt-5 mb-5">
        <button onclick="checkAdminPassword()" class="btn btn-link text-secondary btn-sm" style="text-decoration: none;">ğŸ”’ ç®¡ç†å“¡å¾Œå°</button>
    </div>
</div>

<div class="modal fade" id="menuImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold">ğŸ“¸ å¼å¼Œ-å’ŒèŒ—åœ’ èœå–®åƒè€ƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-img-container">
                <img id="modal-menu-img" src="" alt="èœå–®ç…§ç‰‡">
            </div>
        </div>
    </div>
</div>

<div id="backend-dashboard" style="display: none; background-color: #e9ecef; padding: 30px; min-height: 100vh;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>âš™ï¸ å¾Œå°ç®¡ç†çµ±æ•´</h2>
            <button onclick="logoutBackend()" class="btn btn-danger">è¿”å›å‰å°</button>
        </div>

        <div class="card p-3 mb-4">
            <h4>ğŸ”’ é–å®šæ§åˆ¶</h4>
            <div class="d-flex gap-3">
                <button id="admin-btn-day2" onclick="toggleAdminLock('day2')" class="btn btn-success w-50">è®€å–ä¸­...</button>
                <button id="admin-btn-day3" onclick="toggleAdminLock('day3')" class="btn btn-success w-50">è®€å–ä¸­...</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card p-3 mb-3">
                    <h4>ğŸ“‹ å„å®¶é»é¤æ˜ç´° (å¯ç·¨è¼¯)</h4>
                    <div id="all-orders-list" style="max-height: 600px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            
            <div class="col-md-5">
                <div class="card p-3">
                    <h4>ğŸ“Š æ•¸é‡çµ±è¨ˆ</h4>
                    
                    <button onclick="calculateTotals('day2')" class="btn btn-warning mb-2 w-100">çµ±è¨ˆ DAY 2 (å¼å¼Œ)</button>
                    <div class="mb-3">
                        <label class="form-label small text-muted">DAY 2 å¾Œå°å‚™è¨»ï¼š</label>
                        <textarea id="note-day2" class="form-control form-control-sm" rows="2" placeholder="è¼¸å…¥å‚™è¨»å¾Œè‡ªå‹•å„²å­˜..." onchange="saveAdminNote('day2')"></textarea>
                    </div>

                    <button onclick="calculateTotals('day3')" class="btn btn-info w-100">çµ±è¨ˆ DAY 3 (æ‰“è²“)</button>
                    <div class="mb-3">
                        <label class="form-label small text-muted">DAY 3 å¾Œå°å‚™è¨»ï¼š</label>
                        <textarea id="note-day3" class="form-control form-control-sm" rows="2" placeholder="è¼¸å…¥å‚™è¨»å¾Œè‡ªå‹•å„²å­˜..." onchange="saveAdminNote('day3')"></textarea>
                    </div>

                    <div id="stats-result" class="mt-3 p-2 border bg-white rounded"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================== è¨­å®šå€ ==================
    
    // â˜…â˜…â˜… æ‚¨çš„èœå–®åœ–ç‰‡ç¶²å€ (Facebook é€£çµ) â˜…â˜…â˜…
    const MENU_IMG_URL = "https://scontent.ftpe8-1.fna.fbcdn.net/v/t51.82787-15/629702184_18073429154617664_2483133985369412611_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=127cfc&_nc_ohc=i1dwap3YvBoQ7kNvwEU42j9&_nc_oc=AdlaTfoNJPhaeA4I2c3MLNNGpOuPQw-ZkvTrmrl94NKqb3rtYV6KkxChE8RnneX7E9Y&_nc_zt=23&_nc_ht=scontent.ftpe8-1.fna&_nc_gid=BEYxSXBR6YIOsmPzwHfwSQ&oh=00_AfsAqkZX19l-udQ95f1iphVnVXEXM1dcKk1CmwIVJUiE4Q&oe=6993830A"; 
    
    document.getElementById('modal-menu-img').src = MENU_IMG_URL;

    // å®¶åº­ä»£è™Ÿ
    const FAMILIES = ["å¤ªå¹³", "ç²å®¶", "æå®¶", "è‘µå®¶", "Judyå®¶", "Jillå®¶"];

    // èœå–®è³‡æ–™ (åœ–ç‰‡æ¬„ä½å·²ä¸é‡è¦ï¼Œå› ç‚º CSS çµ±ä¸€éš±è—)
    const MENU_DATA = {
        // DAY 2: å¼å¼Œ-å’ŒèŒ—åœ’
        day2: [
            // (1) ä¸»é¤ - éºµé¡
            { id: "d2_m1_1", category: "ğŸœ (1) ä¸»é¤ï¼šéºµéºµä¿±åˆ°å¥—é¤", name: "é¦™è”¥è‹¦èŒ¶æ²¹è•éº¥éºµ", img: "" },
            { id: "d2_m1_2", category: "ğŸœ (1) ä¸»é¤ï¼šéºµéºµä¿±åˆ°å¥—é¤", name: "è•éº¥å†·éºµæ²¾å¤èŒ¶", img: "" },
            
            // (1-B) éºµé¡æ­é…é£²æ–™
            { id: "d2_d1_1", category: "ğŸ¥¤ éºµéºµä¿±åˆ°-æ­é…é£²æ–™ (è«‹é¸èˆ‡éºµé£Ÿç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç”ŸèŒ¶(ç†±)", img: "" },
            { id: "d2_d1_2", category: "ğŸ¥¤ éºµéºµä¿±åˆ°-æ­é…é£²æ–™ (è«‹é¸èˆ‡éºµé£Ÿç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç”ŸèŒ¶(å†°)", img: "" },
            { id: "d2_d1_3", category: "ğŸ¥¤ éºµéºµä¿±åˆ°-æ­é…é£²æ–™ (è«‹é¸èˆ‡éºµé£Ÿç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç†ŸèŒ¶(ç†±)", img: "" },
            { id: "d2_d1_4", category: "ğŸ¥¤ éºµéºµä¿±åˆ°-æ­é…é£²æ–™ (è«‹é¸èˆ‡éºµé£Ÿç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç†ŸèŒ¶(å†°)", img: "" },

            // (2) ä¸»é¤ - é¤…é¡
            { id: "d2_m2_1", category: "ğŸ• (2) ä¸»é¤ï¼šé¤…é¤…å®‰å®‰å¥—é¤", name: "å—æ´‹å’–å“©èµ·å¸è–„é¤…", img: "" },
            { id: "d2_m2_2", category: "ğŸ• (2) ä¸»é¤ï¼šé¤…é¤…å®‰å®‰å¥—é¤", name: "é’é†¬èŒè‡èµ·å¸è–„é¤…", img: "" },
            { id: "d2_m2_3", category: "ğŸ• (2) ä¸»é¤ï¼šé¤…é¤…å®‰å®‰å¥—é¤", name: "èŠ‹é ­é‡‘èèµ·å¸è–„é¤…", img: "" },

            // (2-B) é¤…é¡æ­é…é£²æ–™
            { id: "d2_d2_1", category: "ğŸ¥¤ é¤…é¤…å®‰å®‰-æ­é…é£²æ–™ (è«‹é¸èˆ‡è–„é¤…ç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç”ŸèŒ¶(ç†±)", img: "" },
            { id: "d2_d2_2", category: "ğŸ¥¤ é¤…é¤…å®‰å®‰-æ­é…é£²æ–™ (è«‹é¸èˆ‡è–„é¤…ç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç”ŸèŒ¶(å†°)", img: "" },
            { id: "d2_d2_3", category: "ğŸ¥¤ é¤…é¤…å®‰å®‰-æ­é…é£²æ–™ (è«‹é¸èˆ‡è–„é¤…ç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç†ŸèŒ¶(ç†±)", img: "" },
            { id: "d2_d2_4", category: "ğŸ¥¤ é¤…é¤…å®‰å®‰-æ­é…é£²æ–™ (è«‹é¸èˆ‡è–„é¤…ç›¸åŒæ•¸é‡)", name: "å¤æ¨¹ç†ŸèŒ¶(å†°)", img: "" },

            // (3) ç”œé»
            { id: "d2_s_1", category: "ğŸ° (3) ç”œé»", name: "å¯éº—éœ²", img: "" },
            { id: "d2_s_2", category: "ğŸ° (3) ç”œé»", name: "èµ·å¸é¦¬éˆ´è–¯çƒ", img: "" },
            { id: "d2_s_3", category: "ğŸ° (3) ç”œé»", name: "é®®å¥¶éº»ç³¬(èŠ±ç”Ÿ)", img: "" },
            { id: "d2_s_4", category: "ğŸ° (3) ç”œé»", name: "é®®å¥¶éº»ç³¬(èŠéº»)", img: "" },
            { id: "d2_s_5", category: "ğŸ° (3) ç”œé»", name: "å¤èŒ¶æ»·å‘³", img: "" }
        ],
        // DAY 3: æ‰“è²“å»šæˆ¿
        day3: [
            { id: "d3_w1", category: "ğŸ— (1) æ‰“è²“é›ç¿…", name: "åŸå‘³é›ç¿…", img: "" },
            { id: "d3_w2", category: "ğŸ— (1) æ‰“è²“é›ç¿…", name: "æ˜¯æ‹‰å·®é›ç¿…", img: "" },
            { id: "d3_m1", category: "ğŸ¥ª (2) ä¸»é¤", name: "è²»åŸç‰›è‚‰èµ·å¸ä¸‰æ˜æ²»", img: "" },
            { id: "d3_m2", category: "ğŸ¥ª (2) ä¸»é¤", name: "æ…¢çƒ¤æ‰‹æ’•è±¬ä¸‰æ˜æ²»", img: "" },
            { id: "d3_m3", category: "ğŸ¥ª (2) ä¸»é¤", name: "çƒ¤è¿·è¿­é¦™é›è…¿æ’ä¸‰æ˜æ²»", img: "" },
            { id: "d3_d1", category: "ğŸ¥¤ (3) é£²æ–™", name: "å¯æ¨‚", img: "" },
            { id: "d3_d2", category: "ğŸ¥¤ (3) é£²æ–™", name: "é›ªç¢§", img: "" },
            { id: "d3_d3", category: "ğŸ¥¤ (3) é£²æ–™", name: "æ‰‹æ‹‰ç”Ÿå•¤", img: "" },
            { id: "d3_d4", category: "ğŸ¥¤ (3) é£²æ–™", name: "é®®æ¦¨æŸ³æ©™æ±", img: "" },
            { id: "d3_d5", category: "ğŸ¥¤ (3) é£²æ–™", name: "æŸ³æ©™é³³è˜‹æ±", img: "" },
            { id: "d3_d6", category: "ğŸ¥¤ (3) é£²æ–™", name: "è‘¡è„æŸšæ±", img: "" },
            { id: "d3_d7", category: "ğŸ¥¤ (3) é£²æ–™", name: "é«˜å±±çƒé¾èŒ¶(ç†±)", img: "" },
            { id: "d3_d8", category: "ğŸ¥¤ (3) é£²æ–™", name: "é«˜å±±çƒé¾èŒ¶(å†°)", img: "" },
            { id: "d3_d9", category: "ğŸ¥¤ (3) é£²æ–™", name: "èœœé¦™ç´…èŒ¶(ç†±)", img: "" },
            { id: "d3_d10", category: "ğŸ¥¤ (3) é£²æ–™", name: "èœœé¦™ç´…èŒ¶(å†°)", img: "" },
            { id: "d3_d11", category: "ğŸ¥¤ (3) é£²æ–™", name: "æ·±ç„™æ‰‹æ²–ç¾å¼å’–å•¡(ç†±)", img: "" },
            { id: "d3_d12", category: "ğŸ¥¤ (3) é£²æ–™", name: "æ·±ç„™æ‰‹æ²–ç¾å¼å’–å•¡(å†°)", img: "" },
            { id: "d3_d13", category: "ğŸ¥¤ (3) é£²æ–™", name: "å–®å“æ‰‹æ²–æ·ºç„™èŒ‰é¦™æŸš(ç†±)", img: "" },
            { id: "d3_d14", category: "ğŸ¥¤ (3) é£²æ–™", name: "å–®å“æ‰‹æ²–æ·ºç„™èŒ‰é¦™æŸš(å†°)", img: "" },
            { id: "d3_d15", category: "ğŸ¥¤ (3) é£²æ–™", name: "åŸå‘³é¦™è‰å¥¶æ˜”", img: "" },
            { id: "d3_d16", category: "ğŸ¥¤ (3) é£²æ–™", name: "é¦™è•‰å¥¶æ˜”", img: "" },
            { id: "d3_d17", category: "ğŸ¥¤ (3) é£²æ–™", name: "å·§å…‹åŠ›å¥¶æ˜”", img: "" }
        ]
    };

    const DEADLINES = {
        day2: new Date('2026-02-20T10:30:00').getTime(),
        day3: new Date('2026-02-21T10:30:00').getTime()
    };

    // Firebase Init
    const firebaseConfig = {
        apiKey: "AIzaSyC_S8VS1Tgtjdh2eyavGR3jN2BmWF_Etg4",
        authDomain: "tainan-trip-order.firebaseapp.com",
        databaseURL: "https://tainan-trip-order-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tainan-trip-order",
        storageBucket: "tainan-trip-order.firebasestorage.app",
        messagingSenderId: "171271367128",
        appId: "1:171271367128:web:91d2cb419a35902dec2aad",
        measurementId: "G-Y8P3XCTS1Q"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================== é‚è¼¯å€ ==================
    let currentOrders = { day2: {}, day3: {} };
    let adminLockState = { day2: false, day3: false };
    let cachedOrders = {};

    // 1. åˆå§‹åŒ–å®¶åº­é¸é …
    const selectElem = document.getElementById('user-select');
    FAMILIES.forEach(fam => {
        const opt = document.createElement('option');
        opt.value = fam;
        opt.innerText = fam;
        selectElem.appendChild(opt);
    });

    // 2. æ¸²æŸ“èœå–®
    function renderMenu(day, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        let lastCategory = "";

        MENU_DATA[day].forEach(item => {
            if (item.category && item.category !== lastCategory) {
                const header = document.createElement('div');
                header.className = "category-header";
                header.innerText = item.category;
                container.appendChild(header);
                lastCategory = item.category;
            }

            const col = document.createElement('div');
            // ä¸€å¾‹ä½¿ç”¨ç´”æ–‡å­—æ’ç‰ˆï¼Œé›»è…¦ç‰ˆä¸€åˆ—å…©å€‹
            col.className = "col-12 col-md-6"; 
            
            col.innerHTML = `
                <div class="menu-item-card">
                    <div class="menu-body">
                        <div class="menu-title">${item.name}</div>
                        <div class="quantity-control">
                            <button class="qty-btn" onclick="updateQty('${day}', '${item.id}', -1)">-</button>
                            <span id="qty-${item.id}" class="qty-display text-primary">0</span>
                            <button class="qty-btn" onclick="updateQty('${day}', '${item.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(col);
        });
    }

    renderMenu('day2', 'menu-container-day2');
    renderMenu('day3', 'menu-container-day3');

    // 3. æ•¸é‡æ›´æ–°
    window.updateQty = function(day, itemId, delta) {
        if (isDayLocked(day)) { alert("è©²å¤©å·²æˆªæ­¢é»é¤ï¼"); return; }
        if (!currentOrders[day]) currentOrders[day] = {};

        let currentQty = currentOrders[day][itemId] || 0;
        let newQty = currentQty + delta;
        if (newQty < 0) newQty = 0;

        currentOrders[day][itemId] = newQty;
        document.getElementById(`qty-${itemId}`).innerText = newQty;
        updateBottomInfo();
    }

    function updateBottomInfo() {
        let total = 0;
        ['day2', 'day3'].forEach(d => Object.values(currentOrders[d] || {}).forEach(q => total += q));
        const info = document.getElementById('current-selection-info');
        info.innerText = total > 0 ? `ç›®å‰ç¸½è¨ˆå·²é¸ ${total} ä»½é¤é»` : "å°šæœªé¸æ“‡é¤é»";
    }

    // 4. é–å®šèˆ‡å€’æ•¸
    function isDayLocked(day) {
        const now = new Date().getTime();
        return (DEADLINES[day] - now < 0) || adminLockState[day];
    }

    function updateLockUI() {
        const now = new Date().getTime();
        ['day2', 'day3'].forEach(day => {
            const distance = DEADLINES[day] - now;
            const timerElem = document.getElementById(`timer-${day}`);
            const locked = isDayLocked(day);
            const container = document.getElementById(`pills-${day}`);
            
            if (locked) {
                timerElem.innerText = adminLockState[day] ? "â›” ç®¡ç†å“¡å·²é–å®š" : "ğŸ›‘ å·²æˆªæ­¢é»é¤";
                if (!container.classList.contains('locked-overlay')) {
                    container.classList.add('locked-overlay');
                    container.querySelectorAll('.qty-btn').forEach(b => b.disabled = true);
                }
            } else {
                const d = Math.floor(distance / (1000*60*60*24));
                const h = Math.floor((distance % (1000*60*60*24))/(1000*60*60));
                const m = Math.floor((distance % (1000*60*60))/(1000*60));
                timerElem.innerText = `â³ å‰©é¤˜ ${d}å¤© ${h}æ™‚ ${m}åˆ†`;
                container.classList.remove('locked-overlay');
                container.querySelectorAll('.qty-btn').forEach(b => b.disabled = false);
            }

            // æ›´æ–°å¾Œå°æŒ‰éˆ•
            const adminBtn = document.getElementById(`admin-btn-${day}`);
            if (adminBtn) {
                if (adminLockState[day]) {
                    adminBtn.innerText = `â›” DAY ${day.slice(-1)} é–å®šä¸­ (é»æ“Šè§£é–)`;
                    adminBtn.className = "btn btn-danger w-50"; 
                } else {
                    adminBtn.innerText = `âœ… DAY ${day.slice(-1)} é–‹æ”¾ä¸­ (é»æ“Šé–å®š)`;
                    adminBtn.className = "btn btn-success w-50";
                }
            }
        });
    }

    // Firebase ç›£è½
    db.ref('adminSettings').on('value', (snapshot) => {
        const val = snapshot.val() || {};
        adminLockState.day2 = val.day2Locked || false;
        adminLockState.day3 = val.day3Locked || false;
        
        if(document.getElementById('note-day2')) document.getElementById('note-day2').value = val.notes?.day2 || "";
        if(document.getElementById('note-day3')) document.getElementById('note-day3').value = val.notes?.day3 || "";
        
        updateLockUI();
    });
    setInterval(updateLockUI, 1000);

    // ================== è³‡æ–™å­˜å– ==================

    window.loadUserOrder = function() {
        const user = document.getElementById('user-select').value;
        if (!user) return;
        document.querySelectorAll('[id^="qty-"]').forEach(el => el.innerText = "0");
        currentOrders = { day2: {}, day3: {} };

        db.ref('orders/' + user).once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
                parseOrderToUI('day2', data.day2);
                parseOrderToUI('day3', data.day3);
            }
            updateBottomInfo();
        });
    }

    function parseOrderToUI(day, str) {
        if (!str) return;
        const items = str.split(', ');
        items.forEach(part => {
            MENU_DATA[day].forEach(menuItem => {
                if (part.includes(menuItem.name)) {
                    const parts = part.split(' x ');
                    if (parts.length === 2) {
                        const qty = parseInt(parts[1]);
                        currentOrders[day][menuItem.id] = qty;
                        const el = document.getElementById(`qty-${menuItem.id}`);
                        if(el) el.innerText = qty;
                    }
                }
            });
        });
    }

    window.submitOrder = function() {
        const user = document.getElementById('user-select').value;
        if (!user) { alert("è«‹å…ˆé¸æ“‡å®¶åº­ä»£è™Ÿï¼"); return; }
        
        // --- æª¢æ ¸é‚è¼¯ ---
        // 1. è¨ˆç®— DAY 2 ä¸»é¤æ•¸é‡
        let d2MainCount = 0;
        let d2DrinkCount = 0;
        const d2Orders = currentOrders['day2'] || {};

        for (const [id, qty] of Object.entries(d2Orders)) {
            if (qty > 0) {
                const item = MENU_DATA['day2'].find(m => m.id === id);
                if (item) {
                    if (item.category.includes("ä¸»é¤")) {
                        d2MainCount += qty;
                    } else if (item.category.includes("æ­é…é£²æ–™")) {
                        d2DrinkCount += qty;
                    }
                }
            }
        }

        // 2. æ¯”å°æ•¸é‡ (å¦‚æœä¸ç›¸ç­‰ï¼Œç¦æ­¢é€å‡º)
        if (d2MainCount !== d2DrinkCount) {
            alert(`âš ï¸ é€å‡ºå¤±æ•—ï¼šä¸»é¤æ•¸é‡èˆ‡é£²æ–™æ•¸é‡ä¸ç›¸ç¬¦ï¼\n\næ‚¨é¸æ“‡äº† ${d2MainCount} ä»½ä¸»é¤ï¼Œä½†é¸æ“‡äº† ${d2DrinkCount} ä»½é£²æ–™ã€‚\nè«‹é‡æ–°ç¢ºèªèª¿æ•´ã€‚`);
            return;
        }
        // --- æª¢æ ¸çµæŸ ---

        const d2Str = generateStr('day2');
        const d3Str = generateStr('day3');
        if (!d2Str && !d3Str) { if(!confirm("é€å‡ºç©ºç™½è¨‚å–®ï¼Ÿ")) return; }

        const updates = {};
        if (!isDayLocked('day2')) updates['day2'] = d2Str;
        if (!isDayLocked('day3')) updates['day3'] = d3Str;
        updates['lastUpdated'] = new Date().toLocaleString();

        db.ref('orders/' + user).update(updates)
            .then(() => alert("âœ… è¨‚å–®æ›´æ–°æˆåŠŸï¼"))
            .catch(err => alert("å¤±æ•—ï¼š" + err.message));
    }

    function generateStr(day) {
        const orders = currentOrders[day];
        let res = [];
        for (const [id, qty] of Object.entries(orders || {})) {
            if (qty > 0) {
                const item = MENU_DATA[day].find(m => m.id === id);
                if (item) res.push(`${item.name} x ${qty}`);
            }
        }
        return res.join(", ");
    }

    // ================== å¾Œå° JS ==================
    window.checkAdminPassword = function() {
        if (prompt("å¯†ç¢¼ï¼š") === "8888") {
            document.getElementById('frontend-app').style.display = 'none';
            document.getElementById('backend-dashboard').style.display = 'block';
            initBackend();
        } else alert("éŒ¯èª¤");
    }

    window.logoutBackend = function() {
        document.getElementById('backend-dashboard').style.display = 'none';
        document.getElementById('frontend-app').style.display = 'block';
    }

    window.toggleAdminLock = function(day) {
        db.ref('adminSettings').update({ [`${day}Locked`]: !adminLockState[day] });
    }

    window.saveAdminNote = function(day) {
        const note = document.getElementById(`note-${day}`).value;
        db.ref('adminSettings/notes').update({ [day]: note });
    }

    function initBackend() {
        const list = document.getElementById('all-orders-list');
        db.ref('orders').on('value', sn => {
            list.innerHTML = "";
            cachedOrders = sn.val() || {};
            if(!cachedOrders) { list.innerHTML="ç„¡è³‡æ–™"; return; }
            
            Object.entries(cachedOrders).forEach(([name, d]) => {
                const div = document.createElement('div');
                div.className = "card mb-2 p-2";
                div.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <strong>${name}</strong>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editOrder('${name}')">âœï¸ ä¿®æ”¹</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder('${name}')">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                    <small class="text-primary d-block mt-1">D2: ${d.day2||'-'}</small>
                    <small class="text-success d-block">D3: ${d.day3||'-'}</small>
                `;
                list.appendChild(div);
            });
            updateLockUI();
        });
    }

    window.deleteOrder = function(userId) {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ ${userId} çš„è¨‚å–®å—ï¼Ÿ`)) {
            db.ref('orders/' + userId).remove();
        }
    }

    window.editOrder = function(userId) {
        const order = cachedOrders[userId];
        const newD2 = prompt(`ä¿®æ”¹ ${userId} çš„ DAY2 è¨‚å–®å…§å®¹ï¼š`, order.day2 || "");
        if (newD2 === null) return;
        const newD3 = prompt(`ä¿®æ”¹ ${userId} çš„ DAY3 è¨‚å–®å…§å®¹ï¼š`, order.day3 || "");
        if (newD3 === null) return;

        db.ref('orders/' + userId).update({
            day2: newD2,
            day3: newD3,
            lastUpdated: new Date().toLocaleString() + " (ç®¡ç†å“¡ä¿®æ”¹)"
        });
    }

    window.calculateTotals = function(day) {
        const div = document.getElementById('stats-result');
        let counts = {};
        Object.values(cachedOrders).forEach(o => {
            const s = o[day];
            if(s) s.split(', ').forEach(p => {
                const [n, q] = p.split(' x ');
                if(n && q) counts[n] = (counts[n]||0) + parseInt(q);
            });
        });
        
        let h = `<h6>${day.toUpperCase()} çµ±è¨ˆ</h6><ul class="list-group">`;
        for(const [n, c] of Object.entries(counts)) {
            h += `<li class="list-group-item d-flex justify-content-between"><span>${n}</span> <span class="badge bg-primary rounded-pill">${c}</span></li>`;
        }
        h += "</ul>";
        div.innerHTML = h;
    }
</script>
</body>
</html>
